{% extends 'base.html' %}
{% load static %}

{% block title %}Editar Producto - {{ producto.nombre }} - Dulcer√≠a Lilis{% endblock %}

{% block extra_css %}
<style>
.form-card {
    background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
    border-radius: 20px;
    padding: 30px;
    color: white;
    margin-bottom: 30px;
}

.form-container {
    background: white;
    border-radius: 15px;
    padding: 30px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
}

.form-section {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
    border-left: 4px solid #f39c12;
}

.form-section h5 {
    color: #f39c12;
    margin-bottom: 15px;
    font-weight: 600;
}

.required::after {
    content: ' *';
    color: #dc3545;
}

.form-control:focus, .form-select:focus {
    border-color: #f39c12;
    box-shadow: 0 0 0 0.2rem rgba(243, 156, 18, 0.25);
}

.btn-warning {
    background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
    border: none;
    color: white;
}

.btn-warning:hover {
    background: linear-gradient(135deg, #e68900 0%, #d35400 100%);
    transform: translateY(-2px);
    color: white;
}

.help-text {
    font-size: 0.875rem;
    color: #6c757d;
    margin-top: 4px;
}

.invalid-feedback {
    display: block;
}

.current-image {
    width: 120px;
    height: 120px;
    object-fit: cover;
    border-radius: 10px;
    border: 2px solid #f39c12;
}

.info-badge {
    background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
    color: white;
    padding: 8px 12px;
    border-radius: 20px;
    font-size: 0.875rem;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="form-card">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2><i class="fas fa-edit me-2"></i>Editar Producto</h2>
                <p class="mb-0">Modificar informaci√≥n de: <strong>{{ producto.nombre }}</strong></p>
            </div>
            <div class="d-flex gap-2">
                <a href="{% url 'maestros:producto_detalle' producto.pk %}" class="btn btn-light">
                    <i class="fas fa-eye me-2"></i>Ver Detalle
                </a>
                <a href="{% url 'maestros:producto_listar' %}" class="btn btn-outline-light">
                    <i class="fas fa-arrow-left me-2"></i>Volver a Lista
                </a>
            </div>
        </div>
    </div>

    <div class="form-container">
        <!-- Info del producto -->
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="info-badge">
                    <i class="fas fa-info-circle me-2"></i>
                    Editando producto creado el {{ producto.created_at|date:"d/m/Y H:i" }}
                    {% if producto.updated_at != producto.created_at %}
                    - √öltima modificaci√≥n: {{ producto.updated_at|date:"d/m/Y H:i" }}
                    {% endif %}
                </div>
            </div>
            <div class="col-md-4 text-end">
                {% if producto.imagen_url %}
                <img src="{{ producto.imagen_url }}" 
                     alt="{{ producto.nombre }}" 
                     class="current-image">
                {% else %}
                <img src="{% static 'img/placeholder.svg' %}" 
                     alt="Sin imagen" 
                     class="current-image">
                {% endif %}
            </div>
        </div>

        <form id="producto-form" method="POST" action="{% url 'maestros:producto_editar' producto.pk %}" novalidate>
            {% csrf_token %}
            
            <!-- Informaci√≥n B√°sica -->
            <div class="form-section">
                <h5><i class="fas fa-info-circle me-2"></i>Informaci√≥n B√°sica</h5>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="sku" class="form-label required">SKU</label>
                        <input type="text" 
                               class="form-control" 
                               id="sku" 
                               name="sku" 
                               value="{{ producto.sku }}"
                               required
                               maxlength="50">
                        <div class="help-text">C√≥digo √∫nico del producto</div>
                        <div class="invalid-feedback" id="sku-error"></div>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="ean_upc" class="form-label">C√≥digo EAN/UPC</label>
                        <input type="text" 
                               class="form-control" 
                               id="ean_upc" 
                               name="ean_upc"
                               value="{{ producto.ean_upc|default:'' }}"
                               maxlength="20">
                        <div class="help-text">C√≥digo de barras (8, 12 o 13 d√≠gitos)</div>
                        <div class="invalid-feedback" id="ean_upc-error"></div>
                    </div>
                    

                    
                    <div class="col-12">
                        <label for="nombre" class="form-label required">Nombre del Producto</label>
                        <input type="text" 
                               class="form-control" 
                               id="nombre" 
                               name="nombre" 
                               value="{{ producto.nombre }}"
                               required
                               maxlength="255">
                        <div class="help-text">Nombre comercial del producto</div>
                        <div class="invalid-feedback" id="nombre-error"></div>
                    </div>
                    
                    <div class="col-12">
                        <label for="descripcion" class="form-label">Descripci√≥n</label>
                        <textarea class="form-control" 
                                  id="descripcion" 
                                  name="descripcion" 
                                  rows="3">{{ producto.descripcion|default:'' }}</textarea>
                        <div class="help-text">Descripci√≥n detallada del producto</div>
                    </div>
                    

                </div>
            </div>

            <!-- Clasificaci√≥n -->
            <div class="form-section">
                <h5><i class="fas fa-tags me-2"></i>Clasificaci√≥n</h5>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="categoria" class="form-label required">Categor√≠a</label>
                        <select class="form-select" id="categoria" name="categoria" required>
                            <option value="">Seleccionar categor√≠a...</option>
                            {% for categoria in categorias %}
                            <option value="{{ categoria.id }}" {% if categoria.id == producto.categoria.id %}selected{% endif %}>
                                {{ categoria.nombre }}
                            </option>
                            {% endfor %}
                        </select>
                        <div class="invalid-feedback" id="categoria-error"></div>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="marca" class="form-label">Marca</label>
                        <select class="form-select" id="marca" name="marca">
                            <option value="">Sin marca espec√≠fica</option>
                            {% for marca in marcas %}
                            <option value="{{ marca.id }}" {% if producto.marca and marca.id == producto.marca.id %}selected{% endif %}>
                                {{ marca.nombre }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="modelo" class="form-label">Modelo</label>
                        <input type="text" 
                               class="form-control" 
                               id="modelo" 
                               name="modelo"
                               value="{{ producto.modelo|default:'' }}"
                               maxlength="100">
                        <div class="help-text">Modelo o variante del producto</div>
                    </div>
                    

                    
                    <div class="col-md-6">
                        <label for="estado" class="form-label required">Estado</label>
                        <div class="mb-2">
                            <small class="text-muted">Estado actual: </small>
                            <span class="badge bg-{% if producto.estado == 'Activo' %}success{% elif producto.estado == 'Inactivo' %}secondary{% elif producto.estado == 'Descontinuado' %}danger{% else %}warning{% endif %}">
                                {{ producto.estado }}
                            </span>
                        </div>
                        <select class="form-select" id="estado" name="estado" required>
                            {% for valor, texto in estados_producto %}
                            <option value="{{ valor }}" {% if valor == producto.estado %}selected{% endif %}>{{ texto }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>

            <!-- Unidades de Medida -->
            <div class="form-section">
                <h5><i class="fas fa-balance-scale me-2"></i>Unidades de Medida</h5>
                <div class="row g-3">
                    <div class="col-md-4">
                        <label for="uom_compra" class="form-label">Unidad de Compra</label>
                        <select class="form-select" id="uom_compra" name="uom_compra">
                            <option value="">Seleccionar unidad...</option>
                            {% for unidad in unidades_medida %}
                            <option value="{{ unidad.id }}" {% if producto.uom_compra and unidad.id == producto.uom_compra.id %}selected{% endif %}>
                                {{ unidad.codigo }} - {{ unidad.nombre }}
                            </option>
                            {% endfor %}
                        </select>
                        <div class="help-text">Unidad para compras</div>
                    </div>
                    
                    <div class="col-md-4">
                        <label for="uom_venta" class="form-label">Unidad de Venta</label>
                        <select class="form-select" id="uom_venta" name="uom_venta">
                            <option value="">Seleccionar unidad...</option>
                            {% for unidad in unidades_medida %}
                            <option value="{{ unidad.id }}" {% if producto.uom_venta and unidad.id == producto.uom_venta.id %}selected{% endif %}>
                                {{ unidad.codigo }} - {{ unidad.nombre }}
                            </option>
                            {% endfor %}
                        </select>
                        <div class="help-text">Unidad para ventas</div>
                    </div>
                    
                    <div class="col-md-4">
                        <label for="uom_stock" class="form-label">Unidad de Stock</label>
                        <select class="form-select" id="uom_stock" name="uom_stock">
                            <option value="">Seleccionar unidad...</option>
                            {% for unidad in unidades_medida %}
                            <option value="{{ unidad.id }}" {% if producto.uom_stock and unidad.id == producto.uom_stock.id %}selected{% endif %}>
                                {{ unidad.codigo }} - {{ unidad.nombre }}
                            </option>
                            {% endfor %}
                        </select>
                        <div class="help-text">Unidad para inventario</div>
                    </div>
                    
                    <div class="col-md-12">
                        <label for="factor_conversion" class="form-label">Factor de Conversi√≥n</label>
                        <input type="number" 
                               class="form-control" 
                               id="factor_conversion" 
                               name="factor_conversion" 
                               step="0.0001"
                               min="0"
                               oninput="this.value = this.value.replace(/[+-]/g, '')"
                               value="{{ producto.factor_conversion|default:'1.0000' }}">
                        <div class="help-text">Factor conversi√≥n entre unidades (ej: 1 caja = 12 unidades)</div>
                    </div>
                </div>
            </div>

            <!-- Precios y Costos -->
            <div class="form-section">
                <h5><i class="fas fa-dollar-sign me-2"></i>Precios y Costos</h5>
                <div class="row g-3">
                    <div class="col-md-4">
                        <label for="costo_estandar" class="form-label">Costo Est√°ndar</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" 
                                   class="form-control" 
                                   id="costo_estandar" 
                                   name="costo_estandar" 
                                   step="0.01"
                                   min="0"
                                   oninput="this.value = this.value.replace(/[+-]/g, '')"
                                   value="{{ producto.costo_estandar|default:'' }}">
                        </div>
                        <div class="help-text">Costo de adquisici√≥n del producto</div>
                        <div class="invalid-feedback" id="costo_estandar-error"></div>
                    </div>
                    
                    <div class="col-md-4">
                        <label for="precio_venta" class="form-label required">Precio de Venta</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" 
                                   class="form-control" 
                                   id="precio_venta" 
                                   name="precio_venta" 
                                   step="0.01"
                                   min="0"
                                   oninput="this.value = this.value.replace(/[+-]/g, '')"
                                   value="{{ producto.precio_venta|default:0 }}"
                                   required>
                        </div>
                        <div class="help-text">Precio de venta al p√∫blico</div>
                        <div class="invalid-feedback" id="precio_venta-error"></div>
                    </div>
                    
                    <div class="col-md-4">
                        <label for="impuesto_iva" class="form-label">IVA (%)</label>
                        <div class="input-group">
                            <input type="number" 
                                   class="form-control" 
                                   id="impuesto_iva" 
                                   name="impuesto_iva" 
                                   step="0.01"
                                   min="0"
                                   max="100"
                                   oninput="this.value = this.value.replace(/[+-]/g, '')"
                                   value="{{ producto.impuesto_iva|default:'19.00' }}">
                            <span class="input-group-text">%</span>
                        </div>
                        <div class="help-text">Porcentaje de IVA aplicable</div>
                        <div class="invalid-feedback" id="impuesto_iva-error"></div>
                    </div>
                </div>
            </div>

            <!-- Control de Stock -->
            <div class="form-section">
                <h5><i class="fas fa-warehouse me-2"></i>Control de Stock</h5>
                <div class="row g-3">
                    <div class="col-md-4">
                        <label for="stock_minimo" class="form-label">Stock M√≠nimo</label>
                        <input type="number" 
                               class="form-control" 
                               id="stock_minimo" 
                               name="stock_minimo" 
                               step="1"
                               min="0"
                               oninput="this.value = this.value.replace(/[+-]/g, '')"
                               value="{{ producto.stock_minimo }}">
                        <div class="help-text">Cantidad m√≠nima en inventario</div>
                        <div class="invalid-feedback" id="stock_minimo-error"></div>
                    </div>
                    
                    <div class="col-md-4">
                        <label for="stock_maximo" class="form-label">Stock M√°ximo</label>
                        <input type="number" 
                               class="form-control" 
                               id="stock_maximo" 
                               name="stock_maximo" 
                               step="1"
                               min="0"
                               oninput="this.value = this.value.replace(/[+-]/g, '')"
                               value="{{ producto.stock_maximo|default:100 }}">
                        <div class="help-text">Cantidad m√°xima recomendada</div>
                    </div>
                    
                    <div class="col-md-4">
                        <label for="punto_reorden" class="form-label">Punto de Reorden</label>
                        <input type="number" 
                               class="form-control" 
                               id="punto_reorden" 
                               name="punto_reorden" 
                               step="1"
                               min="0"
                               oninput="this.value = this.value.replace(/[+-]/g, '')"
                               value="{{ producto.punto_reorden|default:'' }}">
                        <div class="help-text">Punto para generar orden de compra</div>
                    </div>
                </div>
            </div>

            <!-- Caracter√≠sticas -->
            <div class="form-section">
                <h5><i class="fas fa-cogs me-2"></i>Caracter√≠sticas</h5>
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="form-check">
                            <input class="form-check-input" 
                                   type="checkbox" 
                                   id="perishable" 
                                   name="perishable"
                                   {% if producto.perishable %}checked{% endif %}>
                            <label class="form-check-label" for="perishable">
                                <i class="fas fa-calendar-alt me-1"></i>Producto Perecedero
                            </label>
                        </div>
                        <div class="help-text">Requiere control de fechas de vencimiento</div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="form-check">
                            <input class="form-check-input" 
                                   type="checkbox" 
                                   id="control_por_lote" 
                                   name="control_por_lote"
                                   {% if producto.control_por_lote %}checked{% endif %}>
                            <label class="form-check-label" for="control_por_lote">
                                <i class="fas fa-layer-group me-1"></i>Control por Lote
                            </label>
                        </div>
                        <div class="help-text">Seguimiento por lotes de producci√≥n</div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="form-check">
                            <input class="form-check-input" 
                                   type="checkbox" 
                                   id="control_por_serie" 
                                   name="control_por_serie"
                                   {% if producto.control_por_serie %}checked{% endif %}>
                            <label class="form-check-label" for="control_por_serie">
                                <i class="fas fa-barcode me-1"></i>Control por Serie
                            </label>
                        </div>
                        <div class="help-text">Seguimiento individual por n√∫mero de serie</div>
                    </div>
                </div>
            </div>



            </div>

            <!-- Imagen -->
            <div class="form-section">
                <h5><i class="fas fa-image me-2"></i>Imagen del Producto</h5>
                <div class="row g-3">
                    <div class="col-12">
                        <label for="imagen_url" class="form-label">URL de la Imagen</label>
                        <input type="url" 
                               class="form-control" 
                               id="imagen_url" 
                               name="imagen_url"
                               value="{{ producto.imagen_url|default:'' }}"
                               maxlength="500">
                        <div class="help-text">URL completa de la imagen del producto</div>
                    </div>
                </div>
            </div>

            <!-- Botones -->
            <div class="row">
                <div class="col-12">
                    <div class="d-flex justify-content-between">
                        <div class="btn-group">
                            <a href="{% url 'maestros:producto_detalle' producto.pk %}" class="btn btn-outline-info">
                                <i class="fas fa-eye me-2"></i>Ver Detalle
                            </a>
                            <a href="{% url 'maestros:producto_listar' %}" class="btn btn-secondary">
                                <i class="fas fa-times me-2"></i>Cancelar
                            </a>
                        </div>
                        
                        <div class="btn-group">
                            <button type="button" class="btn btn-outline-danger" onclick="window.location.href='{% url 'maestros:producto_eliminar' producto.pk %}'">
                                <i class="fas fa-trash me-2"></i>Eliminar
                            </button>
                            <button type="submit" class="btn btn-warning">
                                <i class="fas fa-save me-2"></i>Guardar Cambios
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>


{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Iniciando JavaScript del formulario de edici√≥n de productos...');
    
    // Debug: verificar elementos cr√≠ticos
    const form = document.getElementById('producto-form');
    const submitBtn = document.querySelector('button[type="submit"]'); // Referencia global
    const skuInput = document.getElementById('sku');
    const nombreInput = document.getElementById('nombre');
    
    console.log('üîç Verificando elementos del DOM:');
    console.log('  - Formulario encontrado:', form ? '‚úÖ SI' : '‚ùå NO');
    console.log('  - Bot√≥n submit encontrado:', submitBtn ? '‚úÖ SI' : '‚ùå NO');
    console.log('  - Input SKU encontrado:', skuInput ? '‚úÖ SI' : '‚ùå NO');
    console.log('  - Input Nombre encontrado:', nombreInput ? '‚úÖ SI' : '‚ùå NO');
    
    if (!form) {
        console.error('‚ùå CR√çTICO: No se encontr√≥ el formulario. Abortando inicializaci√≥n.');
        return;
    }
    
    if (!submitBtn) {
        console.error('‚ùå CR√çTICO: No se encontr√≥ el bot√≥n de submit. Abortando inicializaci√≥n.');
        return;
    }
    
    // Auto-completar unidades de medida similares
    const uomCompra = document.getElementById('uom_compra');
    const uomVenta = document.getElementById('uom_venta');
    const uomStock = document.getElementById('uom_stock');
    
    if (uomCompra) {
        uomCompra.addEventListener('change', function() {
            const selectedValue = this.value;
            if (selectedValue && !uomVenta.value) {
                uomVenta.value = selectedValue;
            }
            if (selectedValue && !uomStock.value) {
                uomStock.value = selectedValue;
            }
        });
    }
    
    // Validaci√≥n y env√≠o del formulario v√≠a AJAX
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault(); // Prevenir env√≠o normal
            console.log('üìù Enviando formulario de edici√≥n de producto...');
            
            // Verificar que los elementos cr√≠ticos est√©n disponibles
            const skuEl = document.getElementById('sku');
            const nombreEl = document.getElementById('nombre');
            const categoriaEl = document.getElementById('categoria');
            const precioEl = document.getElementById('precio_venta');
            
            if (!skuEl || !nombreEl || !categoriaEl || !precioEl) {
                console.error('‚ùå Error: No se encontraron elementos del formulario');
                console.error('  SKU:', !!skuEl, 'Nombre:', !!nombreEl, 'Categoria:', !!categoriaEl, 'Precio:', !!precioEl);
                alert('Error interno: No se pudieron encontrar los campos del formulario');
                return;
            }
            
            // Validaciones simples
            const sku = skuEl.value.trim();
            const nombre = nombreEl.value.trim();
            const categoria = categoriaEl.value;
            const precio = precioEl.value;
            
            if (!sku || !nombre || !categoria || !precio) {
                if (typeof Swal !== 'undefined') {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Datos incompletos',
                        text: 'Por favor, complete todos los campos obligatorios (SKU, Nombre, Categor√≠a, Precio).',
                        confirmButtonColor: '#667eea'
                    });
                } else {
                    alert('Por favor, complete todos los campos obligatorios.');
                }
                return false;
            }
            
            // Validar precio
            if (parseFloat(precio) <= 0) {
                if (typeof Swal !== 'undefined') {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Precio inv√°lido',
                        text: 'El precio debe ser mayor a 0.',
                        confirmButtonColor: '#667eea'
                    });
                } else {
                    alert('El precio debe ser mayor a 0.');
                }
                return false;
            }
            
            // Mostrar loading usando la referencia ya verificada
            console.log('üîÑ Usando bot√≥n de submit previamente verificado:', !!submitBtn);
            
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Guardando...';
            
            // Enviar formulario v√≠a AJAX
            const formData = new FormData(form);
            
            // Debug: mostrar datos del formulario
            console.log('=== DATOS DEL FORMULARIO ===');
            for (let pair of formData.entries()) {
                console.log(pair[0] + ': ' + pair[1]);
            }
            console.log('=== FIN DATOS FORMULARIO ===');
            console.log('Form action:', form.action);
            
            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => {
                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);
                return response.json();
            })
            .then(data => {
                console.log('Response data:', data);
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
                
                if (data.success) {
                    if (typeof Swal !== 'undefined') {
                        Swal.fire({
                            icon: 'success',
                            title: '¬°√âxito!',
                            text: data.message,
                            confirmButtonColor: '#28a745'
                        }).then(() => {
                            if (data.redirect_url) {
                                window.location.href = data.redirect_url;
                            }
                        });
                    } else {
                        alert(data.message);
                        if (data.redirect_url) {
                            window.location.href = data.redirect_url;
                        }
                    }
                } else {
                    let errorMessage = 'Error al guardar el producto.';
                    if (data.errors && Array.isArray(data.errors)) {
                        errorMessage = data.errors.join('\n');
                    } else if (data.message) {
                        errorMessage = data.message;
                    }
                    
                    if (typeof Swal !== 'undefined') {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: errorMessage,
                            confirmButtonColor: '#dc3545'
                        });
                    } else {
                        alert(errorMessage);
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
                
                if (typeof Swal !== 'undefined') {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error de conexi√≥n',
                        text: 'No se pudo conectar con el servidor. Intente nuevamente.',
                        confirmButtonColor: '#dc3545'
                    });
                } else {
                    alert('Error de conexi√≥n. Intente nuevamente.');
                }
            });
            
            console.log('Formulario v√°lido, enviando...');
        });
    }
    
    console.log('JavaScript de edici√≥n de productos cargado correctamente');
});
</script>
{% endblock %}
