{% extends 'base.html' %}
{% load static %}
{% load permisos_tags %}

{% block title %}Productos - Dulcer√≠a Lilis{% endblock %}

<!-- Token CSRF oculto para AJAX -->
<form style="display: none;">
    {% csrf_token %}
</form>

{% block extra_css %}
<style>
.product-image {
    width: 60px;
    height: 60px;
    object-fit: cover;
    border-radius: 8px;
}

.badge-estado {
    font-size: 0.8em;
    padding: 4px 8px;
}

.sortable {
    cursor: pointer;
    user-select: none;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="fas fa-boxes me-2"></i>Gesti√≥n de Productos</h2>
            <p class="text-muted mb-0">Total: <span class="badge bg-primary">{{ total_productos }}</span> productos</p>
        </div>
        <div class="d-flex gap-2">
            <button type="button" class="btn btn-success" onclick="exportarExcel()">
                <i class="fas fa-file-excel me-2"></i>Exportar Excel
            </button>
            {% tiene_permiso 'productos' 'crear' as puede_crear %}
            {% if puede_crear %}
            <a href="{% url 'producto_crear' %}" class="btn btn-primary">
                <i class="fas fa-plus me-2"></i>Nuevo Producto
            </a>
            {% endif %}
        </div>
    </div>

    <!-- Filtros y B√∫squeda -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="GET" id="filtros-form">
                <div class="row g-3">
                    <!-- B√∫squeda -->
                    <div class="col-md-4">
                        <label class="form-label">
                            <i class="fas fa-search me-1"></i>Buscar
                        </label>
                        <input type="text" 
                               class="form-control" 
                               name="query" 
                               value="{{ query }}" 
                               placeholder="SKU, nombre, precio, stock, c√≥digo barras..."
                               id="search-input">
                    </div>

                    <!-- Categor√≠a -->
                    <div class="col-md-2">
                        <label class="form-label">
                            <i class="fas fa-tags me-1"></i>Categor√≠a
                        </label>
                        <select class="form-select" name="categoria" id="categoria-select">
                            <option value="">Todas</option>
                            {% for categoria in categorias %}
                            <option value="{{ categoria.id }}" {% if categoria.id|stringformat:"s" == categoria_id %}selected{% endif %}>
                                {{ categoria.nombre }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Marca -->
                    <div class="col-md-2">
                        <label class="form-label">
                            <i class="fas fa-trademark me-1"></i>Marca
                        </label>
                        <select class="form-select" name="marca" id="marca-select">
                            <option value="">Todas</option>
                            {% for marca in marcas %}
                            <option value="{{ marca.id }}" {% if marca.id|stringformat:"s" == marca_id %}selected{% endif %}>
                                {{ marca.nombre }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Estado -->
                    <div class="col-md-2">
                        <label class="form-label">
                            <i class="fas fa-toggle-on me-1"></i>Estado
                        </label>
                        <select class="form-select" name="estado" id="estado-select">
                            <option value="">Todos</option>
                            <option value="Activo" {% if estado == 'Activo' %}selected{% endif %}>Activo</option>
                            <option value="Inactivo" {% if estado == 'Inactivo' %}selected{% endif %}>Inactivo</option>
                            <option value="Descontinuado" {% if estado == 'Descontinuado' %}selected{% endif %}>Descontinuado</option>
                            <option value="En Desarrollo" {% if estado == 'En Desarrollo' %}selected{% endif %}>En Desarrollo</option>
                        </select>
                    </div>

                    <!-- Botones -->
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary me-2">
                            <i class="fas fa-filter me-1"></i>Filtrar
                        </button>
                        <a href="{% url 'producto_listar' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-times me-1"></i>Limpiar
                        </a>
                    </div>
                </div>

                <!-- Controles adicionales -->
                <div class="row g-3 mt-2 pt-3 border-top">
                    <div class="col-md-3">
                        <label class="form-label">
                            <i class="fas fa-sort me-1"></i>Ordenar por
                        </label>
                        <select class="form-select" name="orden" id="orden-select">
                            {% for valor, texto in orden_options %}
                            <option value="{{ valor }}" {% if orden == valor %}selected{% endif %}>
                                {{ texto }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-2">
                        <label class="form-label">
                            <i class="fas fa-list me-1"></i>Mostrar
                        </label>
                        <select class="form-select" name="items_per_page" id="items-select">
                            {% for option in items_per_page_options %}
                            <option value="{{ option }}" {% if items_per_page == option %}selected{% endif %}>
                                {{ option }} items
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-7 d-flex align-items-end">
                        <div class="text-muted">
                            <small>
                                <i class="fas fa-info-circle me-1"></i>
                                P√°gina {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
                                ({{ page_obj.start_index }}-{{ page_obj.end_index }} de {{ page_obj.paginator.count }} productos)
                            </small>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Tabla de Productos -->
    <div class="card">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th width="80">Imagen</th>
                            <th class="sortable" data-field="sku" onclick="ordenarPor('sku')" style="cursor: pointer;">
                                SKU
                                {% if orden == 'sku' %}
                                    <i class="fas fa-sort-up ms-1"></i>
                                {% elif orden == 'sku_desc' %}
                                    <i class="fas fa-sort-down ms-1"></i>
                                {% else %}
                                    <i class="fas fa-sort ms-1 text-muted"></i>
                                {% endif %}
                            </th>
                            <th class="sortable" data-field="nombre" onclick="ordenarPor('nombre')" style="cursor: pointer;">
                                Producto
                                {% if orden == 'nombre' %}
                                    <i class="fas fa-sort-up ms-1"></i>
                                {% elif orden == 'nombre_desc' %}
                                    <i class="fas fa-sort-down ms-1"></i>
                                {% else %}
                                    <i class="fas fa-sort ms-1 text-muted"></i>
                                {% endif %}
                            </th>
                            <th class="sortable" data-field="categoria" onclick="ordenarPor('categoria')" style="cursor: pointer;">
                                Categor√≠a
                                {% if orden == 'categoria' %}
                                    <i class="fas fa-sort-up ms-1"></i>
                                {% elif orden == 'categoria_desc' %}
                                    <i class="fas fa-sort-down ms-1"></i>
                                {% else %}
                                    <i class="fas fa-sort ms-1 text-muted"></i>
                                {% endif %}
                            </th>
                            <th class="sortable" data-field="marca" onclick="ordenarPor('marca')" style="cursor: pointer;">
                                Marca
                                {% if orden == 'marca' %}
                                    <i class="fas fa-sort-up ms-1"></i>
                                {% elif orden == 'marca_desc' %}
                                    <i class="fas fa-sort-down ms-1"></i>
                                {% else %}
                                    <i class="fas fa-sort ms-1 text-muted"></i>
                                {% endif %}
                            </th>
                            <th class="sortable" data-field="precio" onclick="ordenarPor('precio')" style="cursor: pointer;">
                                Precio Venta
                                {% if orden == 'precio' %}
                                    <i class="fas fa-sort-up ms-1"></i>
                                {% elif orden == 'precio_desc' %}
                                    <i class="fas fa-sort-down ms-1"></i>
                                {% else %}
                                    <i class="fas fa-sort ms-1 text-muted"></i>
                                {% endif %}
                            </th>
                            <th class="sortable" data-field="stock" onclick="ordenarPor('stock')" style="cursor: pointer;">
                                Stock M√≠n.
                                {% if orden == 'stock' %}
                                    <i class="fas fa-sort-up ms-1"></i>
                                {% elif orden == 'stock_desc' %}
                                    <i class="fas fa-sort-down ms-1"></i>
                                {% else %}
                                    <i class="fas fa-sort ms-1 text-muted"></i>
                                {% endif %}
                            </th>
                            <th>Estado</th>
                            <th width="150">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for producto in page_obj %}
                        <tr>
                            <td>
                                {% if producto.imagen_url %}
                                <img src="{{ producto.imagen_url }}" 
                                     alt="{{ producto.nombre }}" 
                                     class="product-image">
                                {% else %}
                                <img src="{% static 'img/placeholder.svg' %}" 
                                     alt="Sin imagen" 
                                     class="product-image">
                                {% endif %}
                            </td>
                            <td>
                                <code class="text-primary">{{ producto.sku }}</code>
                                {% if producto.ean_upc %}
                                <br><small class="text-muted">{{ producto.ean_upc }}</small>
                                {% endif %}
                            </td>
                            <td>
                                <div class="fw-bold">{{ producto.nombre }}</div>
                                {% if producto.descripcion %}
                                <small class="text-muted">{{ producto.descripcion|truncatechars:50 }}</small>
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge bg-secondary">{{ producto.categoria.nombre }}</span>
                            </td>
                            <td>
                                {% if producto.marca %}
                                {{ producto.marca.nombre }}
                                {% else %}
                                <span class="text-muted">Sin marca</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if producto.precio_venta %}
                                <span class="fw-bold text-success">
                                    ${{ producto.precio_venta|floatformat:0 }}
                                </span>
                                {% else %}
                                <span class="text-muted">No definido</span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge bg-info">{{ producto.stock_minimo|floatformat:0 }}</span>
                            </td>
                            <td>
                                {% if producto.estado == 'Activo' %}
                                <span class="badge bg-success badge-estado">Activo</span>
                                {% elif producto.estado == 'Inactivo' %}
                                <span class="badge bg-warning badge-estado">Inactivo</span>
                                {% elif producto.estado == 'Descontinuado' %}
                                <span class="badge bg-danger badge-estado">Descontinuado</span>
                                {% elif producto.estado == 'En Desarrollo' %}
                                <span class="badge bg-info badge-estado">En Desarrollo</span>
                                {% else %}
                                <span class="badge bg-secondary badge-estado">{{ producto.estado }}</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    <a href="{% url 'producto_detalle' producto.pk %}" 
                                       class="btn btn-outline-primary" 
                                       title="Ver detalle">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    {% tiene_permiso 'productos' 'editar' as puede_editar %}
                                    {% if puede_editar %}
                                    <a href="{% url 'producto_editar' producto.pk %}" 
                                       class="btn btn-outline-warning" 
                                       title="Editar">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    {% endif %}
                                    {% tiene_permiso 'productos' 'eliminar' as puede_eliminar %}
                                    {% if puede_eliminar %}
                                    <button type="button"
                                            onclick="confirmarEliminar({{ producto.pk }}, '{{ producto.nombre|escapejs }}')" 
                                            class="btn btn-outline-danger" 
                                            title="Eliminar">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="9" class="text-center py-5">
                                <div class="text-muted">
                                    <i class="fas fa-box-open fa-3x mb-3"></i>
                                    <h5>No se encontraron productos</h5>
                                    <p>No hay productos que coincidan con los filtros seleccionados.</p>
                                    <a href="{% url 'producto_crear' %}" class="btn btn-primary">
                                        <i class="fas fa-plus me-2"></i>Crear primer producto
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Paginaci√≥n Mejorada -->
    {% if page_obj.has_other_pages %}
    <div class="mt-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="text-muted">
                <i class="fas fa-info-circle me-2"></i>
                Mostrando <strong>{{ page_obj.start_index }}</strong> a <strong>{{ page_obj.end_index }}</strong> de <strong>{{ page_obj.paginator.count }}</strong> productos
            </div>
            <div class="text-muted">
                P√°gina <strong>{{ page_obj.number }}</strong> de <strong>{{ page_obj.paginator.num_pages }}</strong>
            </div>
        </div>
        
        <nav aria-label="Paginaci√≥n de productos">
            <ul class="pagination pagination-lg justify-content-center mb-0" style="flex-wrap: wrap;">
                <!-- Primera p√°gina y Anterior -->
                {% if page_obj.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?{% if query %}query={{ query }}&{% endif %}{% if categoria_id %}categoria={{ categoria_id }}&{% endif %}{% if marca_id %}marca={{ marca_id }}&{% endif %}{% if estado %}estado={{ estado }}&{% endif %}orden={{ orden }}&items_per_page={{ items_per_page }}&page=1" title="Primera p√°gina">
                        <i class="fas fa-angle-double-left"></i>
                    </a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?{% if query %}query={{ query }}&{% endif %}{% if categoria_id %}categoria={{ categoria_id }}&{% endif %}{% if marca_id %}marca={{ marca_id }}&{% endif %}{% if estado %}estado={{ estado }}&{% endif %}orden={{ orden }}&items_per_page={{ items_per_page }}&page={{ page_obj.previous_page_number }}" title="P√°gina anterior">
                        <i class="fas fa-chevron-left me-1"></i> Anterior
                    </a>
                </li>
                {% else %}
                <li class="page-item disabled">
                    <span class="page-link">
                        <i class="fas fa-angle-double-left"></i>
                    </span>
                </li>
                <li class="page-item disabled">
                    <span class="page-link">
                        <i class="fas fa-chevron-left me-1"></i> Anterior
                    </span>
                </li>
                {% endif %}

                <!-- P√°ginas numeradas -->
                {% for num in page_obj.paginator.page_range %}
                    {% if page_obj.number == num %}
                    <li class="page-item active">
                        <span class="page-link" style="background-color: #dc2626; border-color: #dc2626;">
                            {{ num }}
                        </span>
                    </li>
                    {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                    <li class="page-item">
                        <a class="page-link" href="?{% if query %}query={{ query }}&{% endif %}{% if categoria_id %}categoria={{ categoria_id }}&{% endif %}{% if marca_id %}marca={{ marca_id }}&{% endif %}{% if estado %}estado={{ estado }}&{% endif %}orden={{ orden }}&items_per_page={{ items_per_page }}&page={{ num }}" style="color: #dc2626;">
                            {{ num }}
                        </a>
                    </li>
                    {% elif num == 1 or num == page_obj.paginator.num_pages %}
                    <li class="page-item">
                        <a class="page-link" href="?{% if query %}query={{ query }}&{% endif %}{% if categoria_id %}categoria={{ categoria_id }}&{% endif %}{% if marca_id %}marca={{ marca_id }}&{% endif %}{% if estado %}estado={{ estado }}&{% endif %}orden={{ orden }}&items_per_page={{ items_per_page }}&page={{ num }}" style="color: #dc2626;">
                            {{ num }}
                        </a>
                    </li>
                    {% elif num == page_obj.number|add:'-3' or num == page_obj.number|add:'3' %}
                    <li class="page-item disabled">
                        <span class="page-link">...</span>
                    </li>
                    {% endif %}
                {% endfor %}

                <!-- Siguiente y √öltima p√°gina -->
                {% if page_obj.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?{% if query %}query={{ query }}&{% endif %}{% if categoria_id %}categoria={{ categoria_id }}&{% endif %}{% if marca_id %}marca={{ marca_id }}&{% endif %}{% if estado %}estado={{ estado }}&{% endif %}orden={{ orden }}&items_per_page={{ items_per_page }}&page={{ page_obj.next_page_number }}" title="P√°gina siguiente">
                        Siguiente <i class="fas fa-chevron-right ms-1"></i>
                    </a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?{% if query %}query={{ query }}&{% endif %}{% if categoria_id %}categoria={{ categoria_id }}&{% endif %}{% if marca_id %}marca={{ marca_id }}&{% endif %}{% if estado %}estado={{ estado }}&{% endif %}orden={{ orden }}&items_per_page={{ items_per_page }}&page={{ page_obj.paginator.num_pages }}" title="√öltima p√°gina">
                        <i class="fas fa-angle-double-right"></i>
                    </a>
                </li>
                {% else %}
                <li class="page-item disabled">
                    <span class="page-link">
                        Siguiente <i class="fas fa-chevron-right ms-1"></i>
                    </span>
                </li>
                <li class="page-item disabled">
                    <span class="page-link">
                        <i class="fas fa-angle-double-right"></i>
                    </span>
                </li>
                {% endif %}
            </ul>
        </nav>
    </div>
    {% endif %}
</div>


{% endblock %}

{% block extra_js %}
<!-- jQuery espec√≠fico para eliminar problemas de carga -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script>
console.log('üîç Verificando jQuery en lista:', typeof $ !== 'undefined' ? '‚úÖ' : '‚ùå');
console.log('üîç Verificando SweetAlert2 en lista:', typeof Swal !== 'undefined' ? '‚úÖ' : '‚ùå');

// Test de ordenamiento despu√©s de cargar la p√°gina
setTimeout(function() {
    console.log('üß™ Ejecutando test de ordenamiento...');
    console.log('Headers ordenables:', $('.sortable').length);
    $('.sortable').each(function(index) {
        const field = $(this).data('field');
        console.log(`Header ${index + 1}: Campo "${field}"`);
    });
    
    // Test del select de ordenamiento
    const ordenSelect = $('#orden-select');
    console.log('Select de ordenamiento encontrado:', ordenSelect.length > 0);
    if (ordenSelect.length > 0) {
        console.log('Opciones disponibles:');
        ordenSelect.find('option').each(function() {
            console.log(`- ${$(this).val()}: ${$(this).text()}`);
        });
    }
}, 1000);
</script>
<script>
$(document).ready(function() {
    console.log('üîß Inicializando controles de productos...');
    console.log('üîç Headers ordenables encontrados:', $('.sortable').length);
    
    // Auto-submit en cambios de select
    $('#categoria-select, #marca-select, #estado-select, #orden-select, #items-select').change(function() {
        console.log('üìù Cambio en select:', $(this).attr('id'), 'Valor:', $(this).val());
        $('#filtros-form').submit();
    });

    // B√∫squeda con debounce
    let searchTimeout;
    $('#search-input').on('input', function() {
        clearTimeout(searchTimeout);
        const query = $(this).val();
        console.log('üîç B√∫squeda:', query);
        searchTimeout = setTimeout(function() {
            $('#filtros-form').submit();
        }, 500);
    });
    
    // Ordenamiento por click en encabezados
    $('.sortable').click(function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        const $this = $(this);
        const field = $this.data('field');
        const currentOrder = '{{ orden }}';
        let newOrder = field;
        
        console.log('üîÑ Click en ordenamiento - Campo:', field, 'Orden actual:', currentOrder);
        
        if (!field) {
            console.error('‚ùå Campo no definido para el header clickeado');
            return;
        }
        
        // L√≥gica de ordenamiento
        if (currentOrder === field) {
            newOrder = field + '_desc';
            console.log('üîΩ Cambiando a descendente');
        } else if (currentOrder === field + '_desc') {
            newOrder = field;
            console.log('üîº Cambiando a ascendente');
        } else {
            newOrder = field;
            console.log('üÜï Primer ordenamiento por este campo');
        }
        
        console.log('üìã Nuevo orden:', newOrder);
        
        // Verificar que el select existe y tiene la opci√≥n
        const $ordenSelect = $('#orden-select');
        if ($ordenSelect.length === 0) {
            console.error('‚ùå Select de ordenamiento no encontrado');
            return;
        }
        
        // Verificar que la opci√≥n existe en el select
        const optionExists = $ordenSelect.find(`option[value="${newOrder}"]`).length > 0;
        console.log('üîç Opci√≥n existe en select:', optionExists);
        
        if (!optionExists) {
            console.warn('‚ö†Ô∏è Opci√≥n no existe, usando ordenamiento directo por URL');
            // Si la opci√≥n no existe en el select, navegar directamente
            const currentUrl = new URL(window.location);
            currentUrl.searchParams.set('orden', newOrder);
            window.location.href = currentUrl.toString();
            return;
        }
        
        // Cambiar el valor del select
        $ordenSelect.val(newOrder);
        console.log('üîç Valor del select despu√©s del cambio:', $ordenSelect.val());
        
        // Enviar formulario
        $('#filtros-form').submit();
    });
});

// Funci√≥n simplificada para ordenamiento directo por URL
function ordenarPor(campo) {
    console.log('üîÑ CLICK EN ORDENAMIENTO - Campo:', campo);
    
    // Feedback visual inmediato
    const header = $(`[data-field="${campo}"]`);
    if (header.length > 0) {
        header.css('background-color', 'rgba(255, 255, 255, 0.2)');
        setTimeout(() => {
            header.css('background-color', '');
        }, 200);
    }
    
    const currentOrder = '{{ orden }}';
    let newOrder = campo;
    
    console.log('üìä Estado actual del ordenamiento:', currentOrder);
    
    // L√≥gica de toggle para el ordenamiento
    if (currentOrder === campo) {
        newOrder = campo + '_desc';
        console.log('üîΩ Cambiando a orden descendente');
    } else if (currentOrder === campo + '_desc') {
        newOrder = campo;
        console.log('üîº Cambiando a orden ascendente');
    } else {
        newOrder = campo;
        console.log('üÜï Estableciendo orden ascendente inicial');
    }
    
    console.log('üìã Nuevo orden determinado:', newOrder);
    
    // Construir URL manteniendo todos los par√°metros actuales
    const currentUrl = new URL(window.location.href);
    currentUrl.searchParams.set('orden', newOrder);
    
    // Asegurar que se mantenga en la p√°gina 1 al cambiar orden
    currentUrl.searchParams.set('page', '1');
    
    const finalUrl = currentUrl.toString();
    console.log('üîó URL final para navegaci√≥n:', finalUrl);
    
    // Mostrar loading breve y navegar
    console.log('üöÄ Navegando a nueva URL...');
    window.location.href = finalUrl;
}

function confirmarEliminar(id, nombre) {
    console.log('üîî Confirmaci√≥n de eliminaci√≥n para producto:', id, nombre);
    
    Swal.fire({
        title: '¬øConfirmar eliminaci√≥n?',
        html: `¬øEst√°s seguro de que deseas eliminar el producto:<br><strong>${nombre}</strong>?`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'S√≠, eliminar',
        cancelButtonText: 'Cancelar',
        reverseButtons: true
    }).then((result) => {
        console.log('ü§î Resultado de confirmaci√≥n:', result);
        if (result.isConfirmed) {
            console.log('‚úÖ Usuario confirm√≥ eliminaci√≥n');
            eliminarProducto(id);
        }
    });
}

function eliminarProducto(id) {
    console.log('üóëÔ∏è Eliminando producto ID:', id);
    
    // Obtener token CSRF directamente desde el template
    const csrfToken = '{{ csrf_token }}';
    console.log('üîë CSRF Token:', csrfToken ? 'Encontrado' : 'NO ENCONTRADO');
    
    if (!csrfToken) {
        Swal.fire({
            title: 'Error de Seguridad',
            text: 'Token CSRF no encontrado. Recarga la p√°gina.',
            icon: 'error'
        });
        return;
    }
    
    $.ajax({
        url: `/maestros/productos/${id}/eliminar/`,
        type: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest'
        },
        beforeSend: function() {
            console.log('üì§ Enviando petici√≥n de eliminaci√≥n...');
        },
        success: function(response) {
            console.log('üì• Respuesta recibida:', response);
            
            if (response.success) {
                Swal.fire({
                    title: '¬°Eliminado!',
                    text: response.message,
                    icon: 'success',
                    timer: 2000,
                    showConfirmButton: false
                }).then(() => {
                    console.log('üîÑ Redirigiendo a:', response.redirect_url);
                    window.location.href = response.redirect_url;
                });
            } else {
                Swal.fire({
                    title: 'Error',
                    text: response.message,
                    icon: 'error'
                });
            }
        },
        error: function(xhr, status, error) {
            console.error('‚ùå Error AJAX:', xhr.status, xhr.statusText);
            console.error('Response:', xhr.responseText);
            
            let errorMessage = 'Error de conexi√≥n. Int√©ntalo de nuevo.';
            
            if (xhr.status === 403) {
                errorMessage = 'No tienes permisos para eliminar este producto.';
            } else if (xhr.status === 404) {
                errorMessage = 'El producto no fue encontrado.';
            } else if (xhr.status === 500) {
                errorMessage = 'Error interno del servidor.';
            }
            
            Swal.fire({
                title: 'Error al Eliminar',
                html: `<strong>Status:</strong> ${xhr.status}<br><strong>Error:</strong> ${errorMessage}`,
                icon: 'error'
            });
        }
    });
}

function exportarExcel() {
    console.log('üìä Iniciando exportaci√≥n a Excel...');
    
    // Mostrar mensaje de carga
    Swal.fire({
        title: 'Exportando datos...',
        text: 'Por favor espera mientras preparamos tu archivo Excel',
        icon: 'info',
        allowOutsideClick: false,
        showConfirmButton: false,
        willOpen: () => {
            Swal.showLoading();
        }
    });
    
    // Construir URL con los filtros actuales
    const urlParams = new URLSearchParams(window.location.search);
    const exportUrl = '{% url "productos_exportar_excel" %}?' + urlParams.toString();
    
    console.log('üîó URL de exportaci√≥n:', exportUrl);
    
    // Crear elemento de descarga invisible
    const link = document.createElement('a');
    link.href = exportUrl;
    link.style.display = 'none';
    document.body.appendChild(link);
    
    // Simular click para descargar
    link.click();
    document.body.removeChild(link);
    
    // Cerrar mensaje de carga despu√©s de un momento
    setTimeout(() => {
        Swal.fire({
            title: '¬°Exportaci√≥n completada!',
            text: 'El archivo Excel se ha descargado correctamente',
            icon: 'success',
            timer: 2000,
            showConfirmButton: false
        });
    }, 1500);
}
</script>
{% endblock %}
