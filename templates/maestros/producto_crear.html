{% extends 'base.html' %}
{% load static %}

{% block title %}Crear Producto - Dulcería Lilis{% endblock %}

{% block extra_css %}
<style>
.form-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 20px;
    padding: 30px;
    color: white;
    margin-bottom: 30px;
}

.form-container {
    background: white;
    border-radius: 15px;
    padding: 30px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
}

.form-section {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
    border-left: 4px solid #667eea;
}

.form-section h5 {
    color: #667eea;
    margin-bottom: 15px;
    font-weight: 600;
}

.required::after {
    content: ' *';
    color: #dc3545;
}

.form-control:focus, .form-select:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
}

.btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
}

.btn-primary:hover {
    background: linear-gradient(135deg, #5a67d8 0%, #6b46a6 100%);
    transform: translateY(-2px);
}

.help-text {
    font-size: 0.875rem;
    color: #6c757d;
    margin-top: 4px;
}

.invalid-feedback {
    display: block;
}

.loading-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 9999;
}

.loading-spinner {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="form-card">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2><i class="fas fa-plus-circle me-2"></i>Crear Nuevo Producto</h2>
                <p class="mb-0">Complete la información del producto</p>
            </div>
            <a href="{% url 'producto_listar' %}" class="btn btn-light">
                <i class="fas fa-arrow-left me-2"></i>Volver a Lista
            </a>
        </div>
    </div>

    <div class="form-container">
        <form id="producto-form" method="POST" novalidate onsubmit="return false;">
            {% csrf_token %}
            
            <!-- Información Básica -->
            <div class="form-section">
                <h5><i class="fas fa-info-circle me-2"></i>Información Básica</h5>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="sku" class="form-label required">SKU</label>
                        <input type="text" 
                               class="form-control" 
                               id="sku" 
                               name="sku" 
                               required
                               maxlength="50">
                        <div class="help-text">Código único del producto (ej: CHOC001)</div>
                        <div class="invalid-feedback" id="sku-error"></div>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="ean_upc" class="form-label">Código EAN/UPC</label>
                        <input type="text" 
                               class="form-control" 
                               id="ean_upc" 
                               name="ean_upc"
                               maxlength="20">
                        <div class="help-text">Código de barras (8, 12 o 13 dígitos)</div>
                        <div class="invalid-feedback" id="ean_upc-error"></div>
                    </div>
                    
                    <div class="col-12">
                        <label for="nombre" class="form-label required">Nombre del Producto</label>
                        <input type="text" 
                               class="form-control" 
                               id="nombre" 
                               name="nombre" 
                               required
                               maxlength="255">
                        <div class="help-text">Nombre comercial del producto</div>
                        <div class="invalid-feedback" id="nombre-error"></div>
                    </div>
                    
                    <div class="col-12">
                        <label for="descripcion" class="form-label">Descripción</label>
                        <textarea class="form-control" 
                                  id="descripcion" 
                                  name="descripcion" 
                                  rows="3"></textarea>
                        <div class="help-text">Descripción detallada del producto</div>
                    </div>
                </div>
            </div>

            <!-- Clasificación -->
            <div class="form-section">
                <h5><i class="fas fa-tags me-2"></i>Clasificación</h5>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="categoria" class="form-label required">Categoría</label>
                        <select class="form-select" id="categoria" name="categoria" required>
                            <option value="">Seleccionar categoría...</option>
                            {% for categoria in categorias %}
                            <option value="{{ categoria.id }}">{{ categoria.nombre }}</option>
                            {% endfor %}
                        </select>
                        <div class="invalid-feedback" id="categoria-error"></div>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="marca" class="form-label">Marca</label>
                        <select class="form-select" id="marca" name="marca">
                            <option value="">Sin marca específica</option>
                            {% for marca in marcas %}
                            <option value="{{ marca.id }}">{{ marca.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="modelo" class="form-label">Modelo</label>
                        <input type="text" 
                               class="form-control" 
                               id="modelo" 
                               name="modelo"
                               maxlength="100">
                        <div class="help-text">Modelo o variante del producto</div>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="estado" class="form-label required">Estado</label>
                        <select class="form-select" id="estado" name="estado" required>
                            {% for valor, texto in estados_producto %}
                            <option value="{{ valor }}" {% if valor == 'ACTIVO' %}selected{% endif %}>{{ texto }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>

            <!-- Unidades de Medida -->
            <div class="form-section">
                <h5><i class="fas fa-balance-scale me-2"></i>Unidades de Medida</h5>
                <div class="row g-3">
                    <div class="col-md-4">
                        <label for="uom_compra" class="form-label required">Unidad de Compra</label>
                        <select class="form-select" id="uom_compra" name="uom_compra" required>
                            <option value="">Seleccionar...</option>
                            {% for unidad in unidades %}
                            <option value="{{ unidad.id }}">{{ unidad.codigo }} - {{ unidad.nombre }}</option>
                            {% endfor %}
                        </select>
                        <div class="invalid-feedback" id="uom_compra-error"></div>
                    </div>
                    
                    <div class="col-md-4">
                        <label for="uom_venta" class="form-label required">Unidad de Venta</label>
                        <select class="form-select" id="uom_venta" name="uom_venta" required>
                            <option value="">Seleccionar...</option>
                            {% for unidad in unidades %}
                            <option value="{{ unidad.id }}">{{ unidad.codigo }} - {{ unidad.nombre }}</option>
                            {% endfor %}
                        </select>
                        <div class="invalid-feedback" id="uom_venta-error"></div>
                    </div>
                    
                    <div class="col-md-4">
                        <label for="uom_stock" class="form-label required">Unidad de Stock</label>
                        <select class="form-select" id="uom_stock" name="uom_stock" required>
                            <option value="">Seleccionar...</option>
                            {% for unidad in unidades %}
                            <option value="{{ unidad.id }}">{{ unidad.codigo }} - {{ unidad.nombre }}</option>
                            {% endfor %}
                        </select>
                        <div class="invalid-feedback" id="uom_stock-error"></div>
                    </div>
                    
                    <div class="col-md-4">
                        <label for="factor_conversion" class="form-label">Factor de Conversión</label>
                        <input type="number" 
                               class="form-control" 
                               id="factor_conversion" 
                               name="factor_conversion" 
                               step="0.0001"
                               value="1">
                        <div class="help-text">Factor conversión compra/venta</div>
                    </div>
                </div>
            </div>

            <!-- Precios y Costos -->
            <div class="form-section">
                <h5><i class="fas fa-dollar-sign me-2"></i>Precios y Costos</h5>
                <div class="row g-3">
                    <div class="col-md-4">
                        <label for="costo_estandar" class="form-label">Costo Estándar</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" 
                                   class="form-control" 
                                   id="costo_estandar" 
                                   name="costo_estandar" 
                                   step="0.01"
                                   min="0">
                        </div>
                        <div class="help-text">Costo de adquisición del producto</div>
                        <div class="invalid-feedback" id="costo_estandar-error"></div>
                    </div>
                    
                    <div class="col-md-4">
                        <label for="precio_venta" class="form-label">Precio de Venta</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" 
                                   class="form-control" 
                                   id="precio_venta" 
                                   name="precio_venta" 
                                   step="0.01"
                                   min="0"
                                   value="0"
                                   required>
                        </div>
                        <div class="help-text">Precio de venta al público</div>
                        <div class="invalid-feedback" id="precio_venta-error"></div>
                    </div>
                    
                    <div class="col-md-4">
                        <label for="impuesto_iva" class="form-label">IVA (%)</label>
                        <div class="input-group">
                            <input type="number" 
                                   class="form-control" 
                                   id="impuesto_iva" 
                                   name="impuesto_iva" 
                                   step="0.01"
                                   min="0"
                                   max="100"
                                   value="19">
                            <span class="input-group-text">%</span>
                        </div>
                        <div class="help-text">Porcentaje de IVA aplicable</div>
                        <div class="invalid-feedback" id="impuesto_iva-error"></div>
                    </div>
                </div>
            </div>

            <!-- Control de Stock -->
            <div class="form-section">
                <h5><i class="fas fa-warehouse me-2"></i>Control de Stock</h5>
                <div class="row g-3">
                    <div class="col-md-4">
                        <label for="stock_minimo" class="form-label">Stock Mínimo</label>
                        <input type="number" 
                               class="form-control" 
                               id="stock_minimo" 
                               name="stock_minimo" 
                               step="0.01"
                               min="0"
                               value="0">
                        <div class="help-text">Cantidad mínima en inventario</div>
                        <div class="invalid-feedback" id="stock_minimo-error"></div>
                    </div>
                    
                    <div class="col-md-4">
                        <label for="stock_maximo" class="form-label">Stock Máximo</label>
                        <input type="number" 
                               class="form-control" 
                               id="stock_maximo" 
                               name="stock_maximo" 
                               step="0.01"
                               min="0"
                               value="100">
                        <div class="help-text">Cantidad máxima recomendada</div>
                        <div class="invalid-feedback" id="stock_maximo-error"></div>
                    </div>
                    
                    <div class="col-md-4">
                        <label for="punto_reorden" class="form-label">Punto de Reorden</label>
                        <input type="number" 
                               class="form-control" 
                               id="punto_reorden" 
                               name="punto_reorden" 
                               step="0.01"
                               min="0">
                        <div class="help-text">Punto para generar orden de compra</div>
                    </div>
                </div>
            </div>

            <!-- Características -->
            <div class="form-section">
                <h5><i class="fas fa-cogs me-2"></i>Características</h5>
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="form-check">
                            <input class="form-check-input" 
                                   type="checkbox" 
                                   id="perishable" 
                                   name="perishable">
                            <label class="form-check-label" for="perishable">
                                <i class="fas fa-calendar-alt me-1"></i>Producto Perecedero
                            </label>
                        </div>
                        <div class="help-text">Requiere control de fechas de vencimiento</div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="form-check">
                            <input class="form-check-input" 
                                   type="checkbox" 
                                   id="control_por_lote" 
                                   name="control_por_lote">
                            <label class="form-check-label" for="control_por_lote">
                                <i class="fas fa-layer-group me-1"></i>Control por Lote
                            </label>
                        </div>
                        <div class="help-text">Seguimiento por lotes de producción</div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="form-check">
                            <input class="form-check-input" 
                                   type="checkbox" 
                                   id="control_por_serie" 
                                   name="control_por_serie">
                            <label class="form-check-label" for="control_por_serie">
                                <i class="fas fa-barcode me-1"></i>Control por Serie
                            </label>
                        </div>
                        <div class="help-text">Seguimiento individual por número de serie</div>
                    </div>
                </div>
            </div>

            <!-- Imagen -->
            <div class="form-section">
                <h5><i class="fas fa-image me-2"></i>Imagen del Producto</h5>
                <div class="row g-3">
                    <div class="col-12">
                        <label for="imagen_url" class="form-label">URL de la Imagen</label>
                        <input type="url" 
                               class="form-control" 
                               id="imagen_url" 
                               name="imagen_url"
                               maxlength="500">
                        <div class="help-text">URL completa de la imagen del producto</div>
                    </div>
                </div>
            </div>

            <!-- Botones -->
            <div class="row">
                <div class="col-12">
                    <div class="d-flex justify-content-between">
                        <a href="{% url 'producto_listar' %}" class="btn btn-secondary">
                            <i class="fas fa-times me-2"></i>Cancelar
                        </a>
                        
                        <div class="btn-group">
                            <button type="button" class="btn btn-outline-primary" onclick="guardarBorrador()">
                                <i class="fas fa-save me-2"></i>Guardar Borrador
                            </button>
                            <button type="button" class="btn btn-primary" onclick="console.log('🔥 BOTÓN CLICKEADO'); guardarProducto();">
                                <i class="fas fa-check me-2"></i>Crear Producto
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Loading overlay -->
<div class="loading-overlay" id="loading-overlay">
    <div class="loading-spinner">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Guardando...</span>
        </div>
        <p class="text-white mt-2">Creando producto...</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- jQuery específico para este template -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script>
$(document).ready(function() {
    // Verificar librerías necesarias
    console.log('🔍 Verificando librerías...');
    console.log('jQuery:', typeof $ !== 'undefined' ? '✅' : '❌');
    console.log('SweetAlert2:', typeof Swal !== 'undefined' ? '✅' : '❌');
    
    // Validación en tiempo real
    $('#sku').on('blur', function() {
        validateSKU();
    });
    
    $('#ean_upc').on('blur', function() {
        validateEANUPC();
    });
    
    // Formulario principal
    $('#producto-form').on('submit', function(e) {
        e.preventDefault();
        console.log('🚀 Formulario interceptado - usando AJAX');
        guardarProducto();
        return false; // Asegurar que no se envíe normalmente
    });
    
    // Auto-completar unidades de medida similares
    $('#uom_compra').on('change', function() {
        const selectedValue = $(this).val();
        if (selectedValue && !$('#uom_venta').val()) {
            $('#uom_venta').val(selectedValue);
        }
        if (selectedValue && !$('#uom_stock').val()) {
            $('#uom_stock').val(selectedValue);
        }
    });
    
    // Validación en tiempo real
    $('#precio_venta').on('input', function() {
        const valor = parseFloat($(this).val()) || 0;
        if (valor > 0) {
            $(this).removeClass('is-invalid').addClass('is-valid');
            $('#precio_venta-error').text('');
        }
    });
    
    $('#stock_maximo').on('input', function() {
        const stockMinimo = parseFloat($('#stock_minimo').val()) || 0;
        const stockMaximo = parseFloat($(this).val()) || 0;
        
        if (stockMaximo >= stockMinimo) {
            $(this).removeClass('is-invalid').addClass('is-valid');
            $('#stock_maximo-error').text('');
        }
    });
    
    // Limpiar errores al escribir en campos requeridos
    $('input[required], select[required]').on('input change', function() {
        if ($(this).val() && $(this).val().trim() !== '') {
            $(this).removeClass('is-invalid').addClass('is-valid');
            $(`#${$(this).attr('id')}-error`).text('');
        }
    });
});

function validateSKU() {
    const sku = $('#sku').val().trim();
    const $skuField = $('#sku');
    const $error = $('#sku-error');
    
    if (!sku) {
        $skuField.addClass('is-invalid');
        $error.text('El SKU es requerido.');
        return false;
    }
    
    if (sku.length < 3) {
        $skuField.addClass('is-invalid');
        $error.text('El SKU debe tener al menos 3 caracteres.');
        return false;
    }
    
    $skuField.removeClass('is-invalid').addClass('is-valid');
    $error.text('');
    return true;
}

function validateEANUPC() {
    const ean = $('#ean_upc').val().trim();
    const $eanField = $('#ean_upc');
    const $error = $('#ean_upc-error');
    
    if (ean) {
        if (!/^\d+$/.test(ean)) {
            $eanField.addClass('is-invalid');
            $error.text('El código EAN/UPC solo debe contener números.');
            return false;
        }
        
        if (![8, 12, 13].includes(ean.length)) {
            $eanField.addClass('is-invalid');
            $error.text('El código EAN/UPC debe tener 8, 12 o 13 dígitos.');
            return false;
        }
    }
    
    $eanField.removeClass('is-invalid').addClass('is-valid');
    $error.text('');
    return true;
}

function validarFormulario() {
    console.log('🔍 Validando formulario...');
    let isValid = true;
    
    // Validar precio de venta
    const precioVenta = parseFloat($('#precio_venta').val()) || 0;
    if (precioVenta <= 0) {
        $('#precio_venta').addClass('is-invalid');
        $('#precio_venta-error').text('El precio de venta debe ser mayor a 0');
        isValid = false;
    }
    
    // Validar stock mínimo y máximo
    const stockMinimo = parseFloat($('#stock_minimo').val()) || 0;
    const stockMaximo = parseFloat($('#stock_maximo').val()) || 0;
    
    if (stockMaximo < stockMinimo) {
        $('#stock_maximo').addClass('is-invalid');
        $('#stock_maximo-error').text('El stock máximo debe ser mayor o igual al mínimo');
        isValid = false;
    }
    
    // Validar campos requeridos
    const camposRequeridos = ['sku', 'nombre', 'categoria', 'uom_compra', 'uom_venta', 'uom_stock'];
    
    camposRequeridos.forEach(campo => {
        const valor = $(`#${campo}`).val();
        if (!valor || valor.trim() === '') {
            $(`#${campo}`).addClass('is-invalid');
            $(`#${campo}-error`).text('Este campo es requerido');
            isValid = false;
        }
    });
    
    console.log(isValid ? '✅ Validación exitosa' : '❌ Errores de validación encontrados');
    return isValid;
}

function guardarProducto() {
    console.log('💾 FUNCIÓN GUARDAR PRODUCTO EJECUTADA');
    
    // Verificar jQuery
    if (typeof $ === 'undefined') {
        Swal.fire({
            icon: 'error',
            title: 'Error de Sistema',
            text: 'jQuery no está cargado. Recarga la página.'
        });
        return;
    }
    
    // Verificar SweetAlert2
    if (typeof Swal === 'undefined') {
        alert('ERROR: SweetAlert2 no está cargado');
        return;
    }
    
    console.log('✅ Librerías verificadas, continuando...');
    
    // Mostrar loading
    $('#loading-overlay').show();
    
    // Limpiar errores previos
    $('.is-invalid').removeClass('is-invalid');
    $('.invalid-feedback').text('');
    
    const formData = new FormData($('#producto-form')[0]);
    console.log('📦 FormData creado');
    
    $.ajax({
        url: '{% url "producto_crear" %}',
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function(response) {
            $('#loading-overlay').hide();
            
            if (response.success) {
                Swal.fire({
                    title: '¡Producto Creado!',
                    text: response.message,
                    icon: 'success',
                    timer: 2000,
                    showConfirmButton: false
                }).then(() => {
                    window.location.href = response.redirect_url;
                });
            } else {
                if (response.errors) {
                    response.errors.forEach(error => {
                        Swal.fire({
                            title: 'Error de Validación',
                            text: error,
                            icon: 'error'
                        });
                    });
                } else {
                    Swal.fire({
                        title: 'Error',
                        text: response.message || 'Error al crear el producto',
                        icon: 'error'
                    });
                }
            }
        },
        error: function(xhr) {
            $('#loading-overlay').hide();
            
            if (xhr.status === 400) {
                const response = xhr.responseJSON;
                if (response && response.errors) {
                    response.errors.forEach(error => {
                        Swal.fire({
                            title: 'Error de Validación',
                            text: error,
                            icon: 'error'
                        });
                    });
                }
            } else {
                Swal.fire({
                    title: 'Error',
                    text: 'Error de conexión. Inténtalo de nuevo.',
                    icon: 'error'
                });
            }
        }
    });
}

function guardarBorrador() {
    const formData = new FormData($('#producto-form')[0]);
    formData.set('estado', 'INACTIVO'); // Guardar como borrador
    
    $('#loading-overlay').show();
    
    $.ajax({
        url: '{% url "producto_crear" %}',
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function(response) {
            $('#loading-overlay').hide();
            
            if (response.success) {
                Swal.fire({
                    title: '¡Borrador Guardado!',
                    text: 'Producto guardado como borrador',
                    icon: 'success',
                    timer: 2000,
                    showConfirmButton: false
                }).then(() => {
                    window.location.href = response.redirect_url;
                });
            }
        },
        error: function() {
            $('#loading-overlay').hide();
            Swal.fire({
                title: 'Error',
                text: 'Error al guardar borrador',
                icon: 'error'
            });
        }
    });
}
</script>
{% endblock %}