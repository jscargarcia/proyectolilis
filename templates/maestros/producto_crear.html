{% extends 'base.html' %}
{% load static %}

{% block title %}Crear Producto - Dulcería Lilis{% endblock %}

{% block extra_css %}
<style>
.form-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 20px;
    padding: 30px;
    color: white;
    margin-bottom: 30px;
}

.form-container {
    background: white;
    border-radius: 15px;
    padding: 30px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
}

.form-section {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
    border-left: 4px solid #667eea;
}

.form-section h5 {
    color: #667eea;
    margin-bottom: 15px;
    font-weight: 600;
}

.required::after {
    content: ' *';
    color: #dc3545;
}

.form-control:focus, .form-select:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
}

.btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
}

.btn-primary:hover {
    background: linear-gradient(135deg, #5a67d8 0%, #6b46a6 100%);
    transform: translateY(-2px);
}

.help-text {
    font-size: 0.875rem;
    color: #6c757d;
    margin-top: 4px;
}

.invalid-feedback {
    display: block;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="form-card">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2><i class="fas fa-plus-circle me-2"></i>Crear Nuevo Producto</h2>
                <p class="mb-0">Complete la información del producto</p>
            </div>
            <a href="{% url 'maestros:producto_listar' %}" class="btn btn-light">
                <i class="fas fa-arrow-left me-2"></i>Volver a Lista
            </a>
        </div>
    </div>

    <div class="form-container">
        <form id="producto-form" method="POST" action="{% url 'maestros:producto_crear' %}" novalidate>
            {% csrf_token %}
            
            <!-- Información Básica -->
            <div class="form-section">
                <h5><i class="fas fa-info-circle me-2"></i>Información Básica</h5>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="sku" class="form-label required">SKU</label>
                        <input type="text" 
                               class="form-control" 
                               id="sku" 
                               name="sku" 
                               required
                               maxlength="50">
                        <div class="help-text">Código único del producto (ej: CHOC001)</div>
                        <div class="invalid-feedback" id="sku-error"></div>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="ean_upc" class="form-label">Código EAN/UPC</label>
                        <input type="text" 
                               class="form-control" 
                               id="ean_upc" 
                               name="ean_upc"
                               maxlength="20">
                        <div class="help-text">Código de barras (8, 12 o 13 dígitos)</div>
                        <div class="invalid-feedback" id="ean_upc-error"></div>
                    </div>
                    
                    <div class="col-12">
                        <label for="nombre" class="form-label required">Nombre del Producto</label>
                        <input type="text" 
                               class="form-control" 
                               id="nombre" 
                               name="nombre" 
                               required
                               maxlength="255">
                        <div class="help-text">Nombre comercial del producto</div>
                        <div class="invalid-feedback" id="nombre-error"></div>
                    </div>
                    
                    <div class="col-12">
                        <label for="descripcion" class="form-label">Descripción</label>
                        <textarea class="form-control" 
                                  id="descripcion" 
                                  name="descripcion" 
                                  rows="3"></textarea>
                        <div class="help-text">Descripción detallada del producto</div>
                    </div>
                </div>
            </div>

            <!-- Clasificación -->
            <div class="form-section">
                <h5><i class="fas fa-tags me-2"></i>Clasificación</h5>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="categoria" class="form-label required">Categoría</label>
                        <select class="form-select" id="categoria" name="categoria" required>
                            <option value="">Seleccionar categoría...</option>
                            {% for categoria in categorias %}
                            <option value="{{ categoria.id }}">{{ categoria.nombre }}</option>
                            {% endfor %}
                        </select>
                        <div class="invalid-feedback" id="categoria-error"></div>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="marca" class="form-label">Marca</label>
                        <select class="form-select" id="marca" name="marca">
                            <option value="">Sin marca específica</option>
                            {% for marca in marcas %}
                            <option value="{{ marca.id }}">{{ marca.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="modelo" class="form-label">Modelo</label>
                        <input type="text" 
                               class="form-control" 
                               id="modelo" 
                               name="modelo"
                               maxlength="100">
                        <div class="help-text">Modelo o variante del producto</div>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="estado" class="form-label required">Estado</label>
                        <select class="form-select" id="estado" name="estado" required>
                            {% for valor, texto in estados_producto %}
                            <option value="{{ valor }}" {% if valor == 'ACTIVO' %}selected{% endif %}>{{ texto }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>

            <!-- Unidades de Medida -->
            <div class="form-section">
                <h5><i class="fas fa-balance-scale me-2"></i>Unidades de Medida</h5>
                <div class="row g-3">
                    <div class="col-md-4">
                        <label for="uom_compra" class="form-label required">Unidad de Compra</label>
                        <select class="form-select" id="uom_compra" name="uom_compra" required>
                            <option value="">Seleccionar...</option>
                            {% for unidad in unidades_medida %}
                            <option value="{{ unidad.id }}">{{ unidad.codigo }} - {{ unidad.nombre }}</option>
                            {% endfor %}
                        </select>
                        <div class="invalid-feedback" id="uom_compra-error"></div>
                    </div>
                    
                    <div class="col-md-4">
                        <label for="uom_venta" class="form-label required">Unidad de Venta</label>
                        <select class="form-select" id="uom_venta" name="uom_venta" required>
                            <option value="">Seleccionar...</option>
                            {% for unidad in unidades_medida %}
                            <option value="{{ unidad.id }}">{{ unidad.codigo }} - {{ unidad.nombre }}</option>
                            {% endfor %}
                        </select>
                        <div class="invalid-feedback" id="uom_venta-error"></div>
                    </div>
                    
                    <div class="col-md-4">
                        <label for="uom_stock" class="form-label required">Unidad de Stock</label>
                        <select class="form-select" id="uom_stock" name="uom_stock" required>
                            <option value="">Seleccionar...</option>
                            {% for unidad in unidades_medida %}
                            <option value="{{ unidad.id }}">{{ unidad.codigo }} - {{ unidad.nombre }}</option>
                            {% endfor %}
                        </select>
                        <div class="invalid-feedback" id="uom_stock-error"></div>
                    </div>
                    
                    <div class="col-md-4">
                        <label for="factor_conversion" class="form-label">Factor de Conversión</label>
                        <input type="number" 
                               class="form-control" 
                               id="factor_conversion" 
                               name="factor_conversion" 
                               step="0.0001"
                               value="1">
                        <div class="help-text">Factor conversión compra/venta</div>
                    </div>
                </div>
            </div>

            <!-- Precios y Costos -->
            <div class="form-section">
                <h5><i class="fas fa-dollar-sign me-2"></i>Precios y Costos</h5>
                <div class="row g-3">
                    <div class="col-md-4">
                        <label for="costo_estandar" class="form-label">Costo Estándar</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" 
                                   class="form-control" 
                                   id="costo_estandar" 
                                   name="costo_estandar" 
                                   step="0.01"
                                   min="0">
                        </div>
                        <div class="help-text">Costo de adquisición del producto</div>
                        <div class="invalid-feedback" id="costo_estandar-error"></div>
                    </div>
                    
                    <div class="col-md-4">
                        <label for="precio_venta" class="form-label">Precio de Venta</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" 
                                   class="form-control" 
                                   id="precio_venta" 
                                   name="precio_venta" 
                                   step="0.01"
                                   min="0"
                                   value="0"
                                   required>
                        </div>
                        <div class="help-text">Precio de venta al público</div>
                        <div class="invalid-feedback" id="precio_venta-error"></div>
                    </div>
                    
                    <div class="col-md-4">
                        <label for="impuesto_iva" class="form-label">IVA (%)</label>
                        <div class="input-group">
                            <input type="number" 
                                   class="form-control" 
                                   id="impuesto_iva" 
                                   name="impuesto_iva" 
                                   step="0.01"
                                   min="0"
                                   max="100"
                                   value="19">
                            <span class="input-group-text">%</span>
                        </div>
                        <div class="help-text">Porcentaje de IVA aplicable</div>
                        <div class="invalid-feedback" id="impuesto_iva-error"></div>
                    </div>
                </div>
            </div>

            <!-- Control de Stock -->
            <div class="form-section">
                <h5><i class="fas fa-warehouse me-2"></i>Control de Stock</h5>
                <div class="row g-3">
                    <div class="col-md-4">
                        <label for="stock_minimo" class="form-label">Stock Mínimo</label>
                        <input type="number" 
                               class="form-control" 
                               id="stock_minimo" 
                               name="stock_minimo" 
                               step="0.01"
                               min="0"
                               value="0">
                        <div class="help-text">Cantidad mínima en inventario</div>
                        <div class="invalid-feedback" id="stock_minimo-error"></div>
                    </div>
                    
                    <div class="col-md-4">
                        <label for="stock_maximo" class="form-label">Stock Máximo</label>
                        <input type="number" 
                               class="form-control" 
                               id="stock_maximo" 
                               name="stock_maximo" 
                               step="0.01"
                               min="0"
                               value="100">
                        <div class="help-text">Cantidad máxima recomendada</div>
                        <div class="invalid-feedback" id="stock_maximo-error"></div>
                    </div>
                    
                    <div class="col-md-4">
                        <label for="punto_reorden" class="form-label">Punto de Reorden</label>
                        <input type="number" 
                               class="form-control" 
                               id="punto_reorden" 
                               name="punto_reorden" 
                               step="0.01"
                               min="0">
                        <div class="help-text">Punto para generar orden de compra</div>
                    </div>
                </div>
            </div>

            <!-- Características -->
            <div class="form-section">
                <h5><i class="fas fa-cogs me-2"></i>Características</h5>
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="form-check">
                            <input class="form-check-input" 
                                   type="checkbox" 
                                   id="perishable" 
                                   name="perishable">
                            <label class="form-check-label" for="perishable">
                                <i class="fas fa-calendar-alt me-1"></i>Producto Perecedero
                            </label>
                        </div>
                        <div class="help-text">Requiere control de fechas de vencimiento</div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="form-check">
                            <input class="form-check-input" 
                                   type="checkbox" 
                                   id="control_por_lote" 
                                   name="control_por_lote">
                            <label class="form-check-label" for="control_por_lote">
                                <i class="fas fa-layer-group me-1"></i>Control por Lote
                            </label>
                        </div>
                        <div class="help-text">Seguimiento por lotes de producción</div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="form-check">
                            <input class="form-check-input" 
                                   type="checkbox" 
                                   id="control_por_serie" 
                                   name="control_por_serie">
                            <label class="form-check-label" for="control_por_serie">
                                <i class="fas fa-barcode me-1"></i>Control por Serie
                            </label>
                        </div>
                        <div class="help-text">Seguimiento individual por número de serie</div>
                    </div>
                </div>
            </div>

            <!-- Imagen -->
            <div class="form-section">
                <h5><i class="fas fa-image me-2"></i>Imagen del Producto</h5>
                <div class="row g-3">
                    <div class="col-12">
                        <label for="imagen_url" class="form-label">URL de la Imagen</label>
                        <input type="url" 
                               class="form-control" 
                               id="imagen_url" 
                               name="imagen_url"
                               maxlength="500">
                        <div class="help-text">URL completa de la imagen del producto</div>
                    </div>
                </div>
            </div>

            <!-- Botones -->
            <div class="row">
                <div class="col-12">
                    <div class="d-flex justify-content-between">
                        <a href="{% url 'maestros:producto_listar' %}" class="btn btn-secondary">
                            <i class="fas fa-times me-2"></i>Cancelar
                        </a>
                        
                        <div class="btn-group">
                            <button type="button" class="btn btn-outline-primary" onclick="guardarBorrador()">
                                <i class="fas fa-save me-2"></i>Guardar Borrador
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-check me-2"></i>Crear Producto
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>


{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Iniciando JavaScript del formulario de productos...');
    
    // Validación básica del formulario
    const form = document.getElementById('producto-form');
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault(); // Prevenir envío normal
            console.log('Enviando formulario de producto...');
            
            // Validaciones simples
            const sku = document.getElementById('sku').value.trim();
            const nombre = document.getElementById('nombre').value.trim();
            const categoria = document.getElementById('categoria').value;
            const precio = document.getElementById('precio_venta').value;
            
            if (!sku || !nombre || !categoria || !precio) {
                if (typeof Swal !== 'undefined') {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Datos incompletos',
                        text: 'Por favor, complete todos los campos obligatorios (SKU, Nombre, Categoría, Precio).',
                        confirmButtonColor: '#667eea'
                    });
                } else {
                    alert('Por favor, complete todos los campos obligatorios.');
                }
                return false;
            }
            
            // Validar precio
            if (parseFloat(precio) <= 0) {
                if (typeof Swal !== 'undefined') {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Precio inválido',
                        text: 'El precio debe ser mayor a 0.',
                        confirmButtonColor: '#667eea'
                    });
                } else {
                    alert('El precio debe ser mayor a 0.');
                }
                return false;
            }
            
            // Mostrar loading
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Creando...';
            
            // Enviar formulario vía AJAX
            const formData = new FormData(form);
            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
                
                if (data.success) {
                    if (typeof Swal !== 'undefined') {
                        Swal.fire({
                            icon: 'success',
                            title: '¡Éxito!',
                            text: data.message,
                            confirmButtonColor: '#28a745'
                        }).then(() => {
                            if (data.redirect_url) {
                                window.location.href = data.redirect_url;
                            }
                        });
                    } else {
                        alert(data.message);
                        if (data.redirect_url) {
                            window.location.href = data.redirect_url;
                        }
                    }
                } else {
                    let errorMessage = 'Error al crear el producto.';
                    if (data.errors && Array.isArray(data.errors)) {
                        errorMessage = data.errors.join('\n');
                    } else if (data.message) {
                        errorMessage = data.message;
                    }
                    
                    if (typeof Swal !== 'undefined') {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: errorMessage,
                            confirmButtonColor: '#dc3545'
                        });
                    } else {
                        alert(errorMessage);
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
                
                if (typeof Swal !== 'undefined') {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error de conexión',
                        text: 'No se pudo conectar con el servidor. Intente nuevamente.',
                        confirmButtonColor: '#dc3545'
                    });
                } else {
                    alert('Error de conexión. Intente nuevamente.');
                }
            });
            
            console.log('Formulario válido, enviando...');
        });
    }
    
    // Auto-completar unidades de medida similares
    const uomCompra = document.getElementById('uom_compra');
    const uomVenta = document.getElementById('uom_venta');
    const uomStock = document.getElementById('uom_stock');
    
    if (uomCompra) {
        uomCompra.addEventListener('change', function() {
            const selectedValue = this.value;
            if (selectedValue && !uomVenta.value) {
                uomVenta.value = selectedValue;
            }
            if (selectedValue && !uomStock.value) {
                uomStock.value = selectedValue;
            }
        });
    }
    
    console.log('JavaScript de productos cargado correctamente');
});
</script>
{% endblock %}
