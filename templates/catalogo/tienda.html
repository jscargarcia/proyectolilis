{% extends 'base.html' %}
{% load static %}

{% block title %}Tienda - Dulcería Lilis{% endblock %}

{% block extra_css %}
<style>
    .tienda-header {
        background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        color: white;
        padding: 3rem 0;
        margin-bottom: 2rem;
        border-radius: 0 0 20px 20px;
        box-shadow: 0 4px 15px rgba(233, 30, 99, 0.3);
    }
    
    .producto-card {
        border: none;
        border-radius: 15px;
        overflow: hidden;
        transition: all 0.3s ease;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        height: 100%;
    }
    
    .producto-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(233, 30, 99, 0.3);
    }
    
    .producto-imagen {
        width: 100%;
        height: 200px;
        object-fit: cover;
        background: linear-gradient(135deg, #fce4ec 0%, #f8bbd0 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 4rem;
        color: #dc2626;
    }
    
    .producto-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        background: #28a745;
        color: white;
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: bold;
    }
    
    .producto-info {
        padding: 1.5rem;
    }
    
    .producto-nombre {
        font-size: 1.1rem;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 0.5rem;
        height: 2.5rem;
        overflow: hidden;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
    }
    
    .producto-descripcion {
        color: #7f8c8d;
        font-size: 0.9rem;
        margin-bottom: 1rem;
        height: 3rem;
        overflow: hidden;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
    }
    
    .producto-precio {
        font-size: 1.8rem;
        font-weight: bold;
        color: #dc2626;
        margin-bottom: 1rem;
    }
    
    .producto-sku {
        font-size: 0.85rem;
        color: #95a5a6;
        margin-bottom: 0.5rem;
    }
    
    .btn-agregar-carrito {
        background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        border: none;
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 25px;
        font-weight: 600;
        width: 100%;
        transition: all 0.3s ease;
    }
    
    .btn-agregar-carrito:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 15px rgba(233, 30, 99, 0.4);
        color: white;
    }
    
    .filtros-sidebar {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
    }
    
    .filtro-titulo {
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #dc2626;
    }
    
    .sin-productos {
        text-align: center;
        padding: 3rem;
        color: #7f8c8d;
    }
    
    .sin-productos i {
        font-size: 4rem;
        margin-bottom: 1rem;
        color: #dc2626;
    }
</style>
{% endblock %}

{% block content %}
<!-- Header de la tienda -->
<div class="tienda-header">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="mb-0">
                    <i class="fas fa-candy-cane me-2"></i>
                    Tienda Dulcería Lilis
                </h1>
                <p class="mb-0 mt-2">Los mejores dulces y golosinas para ti</p>
            </div>
            <div class="col-md-4 text-end">
                <a href="{% url 'api:carrito_ver' %}" class="btn btn-light btn-lg">
                    <i class="fas fa-shopping-cart me-2"></i>
                    Ver Carrito
                    <span class="badge bg-danger ms-2" id="carrito-count">{{ carrito_count }}</span>
                </a>
            </div>
        </div>
    </div>
</div>

<div class="container mt-4">
    <div class="row">
        <!-- Sidebar de filtros -->
        <div class="col-lg-3">
            <div class="filtros-sidebar">
                <h5 class="filtro-titulo">
                    <i class="fas fa-filter me-2"></i>Filtros
                </h5>
                
                <form method="get" id="filtrosForm">
                    <!-- Búsqueda -->
                    <div class="mb-3">
                        <label class="form-label">Buscar</label>
                        <input type="text" name="q" class="form-control" 
                               placeholder="Nombre o SKU..." value="{{ query }}"
                               onchange="this.form.submit()">
                    </div>
                    
                    <!-- Categoría -->
                    <div class="mb-3">
                        <label class="form-label">Categoría</label>
                        <select name="categoria" class="form-select" onchange="this.form.submit()">
                            <option value="">Todas las categorías</option>
                            {% for cat in categorias %}
                            <option value="{{ cat.id }}" {% if categoria_filter == cat.id|stringformat:'s' %}selected{% endif %}>
                                {{ cat.nombre }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Marca -->
                    <div class="mb-3">
                        <label class="form-label">Marca</label>
                        <select name="marca" class="form-select" onchange="this.form.submit()">
                            <option value="">Todas las marcas</option>
                            {% for marca in marcas %}
                            <option value="{{ marca.id }}" {% if marca_filter == marca.id|stringformat:'s' %}selected{% endif %}>
                                {{ marca.nombre }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Ordenar -->
                    <div class="mb-3">
                        <label class="form-label">Ordenar por</label>
                        <select name="orden" class="form-select" onchange="this.form.submit()">
                            <option value="nombre" {% if orden == 'nombre' %}selected{% endif %}>Nombre A-Z</option>
                            <option value="nombre_desc" {% if orden == 'nombre_desc' %}selected{% endif %}>Nombre Z-A</option>
                            <option value="precio" {% if orden == 'precio' %}selected{% endif %}>Precio menor</option>
                            <option value="precio_desc" {% if orden == 'precio_desc' %}selected{% endif %}>Precio mayor</option>
                            <option value="nuevo" {% if orden == 'nuevo' %}selected{% endif %}>Más nuevos</option>
                        </select>
                    </div>
                    
                    <button type="button" class="btn btn-outline-secondary w-100" onclick="window.location.href='{% url 'catalogo:tienda_productos' %}'">
                        <i class="fas fa-times me-2"></i>Limpiar filtros
                    </button>
                </form>
            </div>
        </div>
        
        <!-- Grid de productos -->
        <div class="col-lg-9">
            <!-- Resultados info -->
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">
                    {% if page_obj.paginator.count %}
                        Mostrando {{ page_obj.start_index }}-{{ page_obj.end_index }} de {{ page_obj.paginator.count }} productos
                    {% else %}
                        No se encontraron productos
                    {% endif %}
                </h5>
            </div>
            
            {% if page_obj %}
                <div class="row g-4">
                    {% for producto in page_obj %}
                    <div class="col-md-4">
                        <div class="card producto-card">
                            <div class="position-relative">
                                {% if producto.imagen %}
                                    <img src="{{ producto.imagen.url }}" class="producto-imagen" alt="{{ producto.nombre }}">
                                {% else %}
                                    <div class="producto-imagen">
                                        <i class="fas fa-candy-cane"></i>
                                    </div>
                                {% endif %}
                                <span class="producto-badge">Disponible</span>
                            </div>
                            
                            <div class="producto-info">
                                <div class="producto-sku">SKU: {{ producto.sku }}</div>
                                <h5 class="producto-nombre">{{ producto.nombre }}</h5>
                                
                                {% if producto.descripcion %}
                                <p class="producto-descripcion">{{ producto.descripcion|truncatewords:15 }}</p>
                                {% else %}
                                <p class="producto-descripcion text-muted">Sin descripción</p>
                                {% endif %}
                                
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <div class="producto-precio">${{ producto.precio_venta|floatformat:0 }}</div>
                                    {% if producto.marca %}
                                    <span class="badge bg-secondary">{{ producto.marca.nombre }}</span>
                                    {% endif %}
                                </div>
                                
                                <button class="btn btn-agregar-carrito" 
                                        onclick="agregarAlCarrito('{{ producto.id }}', '{{ producto.nombre }}', {{ producto.precio_venta }})">
                                    <i class="fas fa-cart-plus me-2"></i>Agregar al carrito
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- Paginación -->
                {% if page_obj.has_other_pages %}
                <div class="pagination-wrapper mt-4">
                    <!-- Información de registros -->
                    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
                        <div class="text-muted">
                            <span>Mostrando <strong>{{ page_obj.start_index }}</strong> - <strong>{{ page_obj.end_index }}</strong> de <strong>{{ page_obj.paginator.count }}</strong> productos</span>
                        </div>
                        <div class="text-muted">
                            <span>Página <strong>{{ page_obj.number }}</strong> de <strong>{{ page_obj.paginator.num_pages }}</strong></span>
                        </div>
                    </div>

                    <!-- Controles de paginación -->
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                        <!-- Navegación con botones -->
                        <nav aria-label="Navegación de páginas" class="flex-grow-1">
                            <ul class="pagination justify-content-center mb-0">
                                <!-- Primera página -->
                                {% if page_obj.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?page=1{% if query %}&q={{ query }}{% endif %}{% if categoria_filter %}&categoria={{ categoria_filter }}{% endif %}{% if marca_filter %}&marca={{ marca_filter }}{% endif %}{% if orden %}&orden={{ orden }}{% endif %}" title="Primera página">
                                        <i class="fas fa-angle-double-left"></i>
                                    </a>
                                </li>
                                {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link">
                                        <i class="fas fa-angle-double-left"></i>
                                    </span>
                                </li>
                                {% endif %}

                                <!-- Página anterior -->
                                {% if page_obj.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if query %}&q={{ query }}{% endif %}{% if categoria_filter %}&categoria={{ categoria_filter }}{% endif %}{% if marca_filter %}&marca={{ marca_filter }}{% endif %}{% if orden %}&orden={{ orden }}{% endif %}" title="Anterior">
                                        <i class="fas fa-angle-left"></i>
                                    </a>
                                </li>
                                {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link">
                                        <i class="fas fa-angle-left"></i>
                                    </span>
                                </li>
                                {% endif %}

                                <!-- Páginas numeradas -->
                                {% if page_obj.number > 3 %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page=1{% if query %}&q={{ query }}{% endif %}{% if categoria_filter %}&categoria={{ categoria_filter }}{% endif %}{% if marca_filter %}&marca={{ marca_filter }}{% endif %}{% if orden %}&orden={{ orden }}{% endif %}">1</a>
                                    </li>
                                    {% if page_obj.number > 4 %}
                                        <li class="page-item disabled">
                                            <span class="page-link">...</span>
                                        </li>
                                    {% endif %}
                                {% endif %}

                                {% for num in page_obj.paginator.page_range %}
                                    {% if page_obj.number == num %}
                                        <li class="page-item active" aria-current="page">
                                            <span class="page-link" style="background-color: #dc2626; border-color: #dc2626;">
                                                {{ num }}
                                            </span>
                                        </li>
                                    {% elif num >= page_obj.number|add:"-2" and num <= page_obj.number|add:"2" %}
                                        <li class="page-item">
                                            <a class="page-link" href="?page={{ num }}{% if query %}&q={{ query }}{% endif %}{% if categoria_filter %}&categoria={{ categoria_filter }}{% endif %}{% if marca_filter %}&marca={{ marca_filter }}{% endif %}{% if orden %}&orden={{ orden }}{% endif %}">{{ num }}</a>
                                        </li>
                                    {% endif %}
                                {% endfor %}

                                {% if page_obj.number < page_obj.paginator.num_pages|add:"-2" %}
                                    {% if page_obj.number < page_obj.paginator.num_pages|add:"-3" %}
                                        <li class="page-item disabled">
                                            <span class="page-link">...</span>
                                        </li>
                                    {% endif %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if query %}&q={{ query }}{% endif %}{% if categoria_filter %}&categoria={{ categoria_filter }}{% endif %}{% if marca_filter %}&marca={{ marca_filter }}{% endif %}{% if orden %}&orden={{ orden }}{% endif %}">{{ page_obj.paginator.num_pages }}</a>
                                    </li>
                                {% endif %}

                                <!-- Página siguiente -->
                                {% if page_obj.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if query %}&q={{ query }}{% endif %}{% if categoria_filter %}&categoria={{ categoria_filter }}{% endif %}{% if marca_filter %}&marca={{ marca_filter }}{% endif %}{% if orden %}&orden={{ orden }}{% endif %}" title="Siguiente">
                                        <i class="fas fa-angle-right"></i>
                                    </a>
                                </li>
                                {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link">
                                        <i class="fas fa-angle-right"></i>
                                    </span>
                                </li>
                                {% endif %}

                                <!-- Última página -->
                                {% if page_obj.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if query %}&q={{ query }}{% endif %}{% if categoria_filter %}&categoria={{ categoria_filter }}{% endif %}{% if marca_filter %}&marca={{ marca_filter }}{% endif %}{% if orden %}&orden={{ orden }}{% endif %}" title="Última página">
                                        <i class="fas fa-angle-double-right"></i>
                                    </a>
                                </li>
                                {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link">
                                        <i class="fas fa-angle-double-right"></i>
                                    </span>
                                </li>
                                {% endif %}
                            </ul>
                        </nav>

                        <!-- Ir a página específica -->
                        <div class="d-flex align-items-center gap-2">
                            <label for="page-jump-tienda" class="text-muted mb-0 text-nowrap">Ir a:</label>
                            <input type="number" 
                                   id="page-jump-tienda" 
                                   class="form-control form-control-sm" 
                                   style="width: 70px;" 
                                   min="1" 
                                   max="{{ page_obj.paginator.num_pages }}" 
                                   value="{{ page_obj.number }}"
                                   oninput="this.value = this.value.replace(/[+-]/g, '')">
                            <button type="button" 
                                    class="btn btn-sm text-white" 
                                    style="background-color: #dc2626; border-color: #dc2626;"
                                    onclick="goToPageTienda()">
                                <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <style>
                .pagination-wrapper .pagination {
                    flex-wrap: wrap;
                    gap: 2px;
                }

                .pagination-wrapper .page-link {
                    border-radius: 0.25rem;
                    margin: 0 2px;
                    min-width: 38px;
                    text-align: center;
                    transition: all 0.2s ease;
                }

                .pagination-wrapper .page-link:hover:not(.disabled) {
                    transform: translateY(-2px);
                    box-shadow: 0 2px 8px rgba(233, 30, 99, 0.3);
                }

                .pagination-wrapper .page-item.active .page-link {
                    font-weight: 600;
                }

                .pagination-wrapper .page-item.disabled .page-link {
                    background-color: #f8f9fa;
                    border-color: #dee2e6;
                }

                @media (max-width: 768px) {
                    .pagination-wrapper .d-flex {
                        flex-direction: column;
                        align-items: center !important;
                    }
                    
                    .pagination-wrapper nav {
                        width: 100%;
                    }
                    
                    .pagination-wrapper .page-link {
                        font-size: 0.875rem;
                        min-width: 32px;
                        padding: 0.25rem 0.5rem;
                    }
                }
                </style>

                <script>
                function goToPageTienda() {
                    const pageInput = document.getElementById('page-jump-tienda');
                    const pageNumber = parseInt(pageInput.value);
                    const maxPages = {{ page_obj.paginator.num_pages }};
                    
                    if (pageNumber >= 1 && pageNumber <= maxPages) {
                        const currentUrl = new URL(window.location.href);
                        currentUrl.searchParams.set('page', pageNumber);
                        window.location.href = currentUrl.toString();
                    } else {
                        alert('Por favor ingrese un número de página válido (1-' + maxPages + ')');
                    }
                }

                // Permitir Enter para ir a la página
                document.getElementById('page-jump-tienda').addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        goToPageTienda();
                    }
                });
                </script>
                {% endif %}
            {% else %}
                <div class="sin-productos">
                    <i class="fas fa-search"></i>
                    <h4>No se encontraron productos</h4>
                    <p>Intenta ajustar los filtros de búsqueda</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
function agregarAlCarrito(productoId, nombre, precio) {
    fetch("{% url 'api:carrito_agregar' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            item_id: productoId,
            nombre: nombre,
            precio: precio,
            cantidad: 1
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Actualizar contador
            document.getElementById('carrito-count').textContent = data.count;
            
            // Mostrar alerta de éxito
            Swal.fire({
                icon: 'success',
                title: '¡Producto agregado!',
                text: data.message,
                showCancelButton: true,
                confirmButtonText: 'Ver carrito',
                cancelButtonText: 'Seguir comprando',
                confirmButtonColor: '#dc2626',
                cancelButtonColor: '#6c757d'
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = "{% url 'api:carrito_ver' %}";
                }
            });
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: data.error || 'No se pudo agregar el producto'
            });
        }
    })
    .catch(error => {
        console.error('Error:', error);
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Ocurrió un error al agregar el producto'
        });
    });
}

// Actualizar contador del carrito al cargar la página
document.addEventListener('DOMContentLoaded', function() {
    fetch("{% url 'api:carrito_count' %}")
        .then(response => response.json())
        .then(data => {
            document.getElementById('carrito-count').textContent = data.count;
        })
        .catch(error => console.error('Error:', error));
});
</script>
{% endblock %}

