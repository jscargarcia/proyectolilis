{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recuperar Contraseña - Lilis System</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="{% static 'img/logo.svg' %}">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- SweetAlert2 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    
    <!-- Custom Login CSS -->
    <link rel="stylesheet" href="{% static 'css/login.css' %}">
    
    <style>
        .form-control.is-valid {
            border-color: #28a745;
            padding-right: calc(1.5em + 0.75rem);
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%2328a745' d='M2.3 6.73L.6 4.53c-.4-1.04.46-1.4 1.1-.8l1.1 1.4 3.4-3.8c.6-.63 1.6-.27 1.2.7l-4 4.6c-.43.5-.8.4-1.1.1z'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right calc(0.375em + 0.1875rem) center;
            background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
        }
        
        .form-control.is-invalid {
            border-color: #dc3545;
            padding-right: calc(1.5em + 0.75rem);
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right calc(0.375em + 0.1875rem) center;
            background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
        }
        
        .invalid-feedback, .valid-feedback {
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }
        
        .invalid-feedback {
            color: #dc3545;
        }
        
        .valid-feedback {
            color: #28a745;
        }
        
        .invalid-feedback i, .valid-feedback i {
            margin-right: 0.25rem;
        }
    </style>
</head>
<body>
    <div class="login-container">
        <div class="login-card">
            <div class="login-header">
                <img src="{% static 'img/logo.svg' %}" alt="Lili's Logo" width="80" height="80" class="mb-3">
                <h3>Dulcería Lili's</h3>
                <p class="mb-0">Recuperar Contraseña</p>
            </div>
            
            <div class="login-body">
                <form id="formRecuperarPassword" method="post" action="{% url 'autenticacion:recuperar_password' %}" class="login-form">
                    {% csrf_token %}
                    
                    <div class="form-group">
                        <i class="input-icon fas fa-envelope"></i>
                        <input 
                            type="email" 
                            class="form-control" 
                            id="email" 
                            name="email" 
                            placeholder="Correo Electrónico"
                            required
                            autofocus
                        >
                        <div class="invalid-feedback" id="email-feedback" style="display: none;">
                            <i class="fas fa-exclamation-circle"></i>
                            <span id="email-error-message"></span>
                        </div>
                        <div class="valid-feedback" id="email-valid-feedback" style="display: none;">
                            <i class="fas fa-check-circle"></i>
                            Correo registrado en el sistema
                        </div>
                    </div>
                    
                    <div class="alert alert-info" style="border-radius: 8px; border-left: 4px solid #dc2626;">
                        <h6 class="alert-heading mb-2">
                            <i class="fas fa-info-circle"></i>
                            ¿Cómo funciona?
                        </h6>
                        <ul class="mb-0" style="font-size: 0.85rem; padding-left: 1.2rem;">
                            <li>Ingresa tu correo electrónico registrado</li>
                            <li>Recibirás un código de 6 dígitos por email</li>
                            <li>Usa ese código para crear tu nueva contraseña</li>
                            <li>El código expira en 10 minutos por seguridad</li>
                        </ul>
                    </div>
                    
                    <button type="submit" class="btn login-btn">
                        <i class="fas fa-paper-plane"></i> Enviar Código de Recuperación
                    </button>
                </form>
                
                <div class="text-center mt-3">
                    <a href="{% url 'autenticacion:login' %}" class="text-decoration-none" 
                       style="color: #dc2626; font-size: 0.9rem;">
                        <i class="fas fa-arrow-left"></i> Volver al Login
                    </a>
                </div>
            </div>
            
            <div class="login-footer">
                <p class="mb-0">&copy; 2025 Dulcería Lilis - Todos los derechos reservados</p>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- SweetAlert2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script>
        // Mostrar mensajes con SweetAlert2
        {% if messages %}
            {% for message in messages %}
                Swal.fire({
                    icon: '{% if message.tags == "success" %}success{% elif message.tags == "error" or message.tags == "danger" %}error{% elif message.tags == "warning" %}warning{% else %}info{% endif %}',
                    title: '{% if message.tags == "success" %}¡Éxito!{% elif message.tags == "error" or message.tags == "danger" %}Error{% elif message.tags == "warning" %}Advertencia{% else %}Información{% endif %}',
                    text: '{{ message|escapejs }}',
                    confirmButtonColor: '#dc2626'
                });
            {% endfor %}
        {% endif %}
        
        // Manejo del formulario
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('formRecuperarPassword');
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            const emailInput = document.getElementById('email');
            const emailFeedback = document.getElementById('email-feedback');
            const emailValidFeedback = document.getElementById('email-valid-feedback');
            const emailErrorMessage = document.getElementById('email-error-message');
            
            let emailValidado = false;
            let timeoutId = null;
            
            // Validación de email en tiempo real
            emailInput.addEventListener('input', function() {
                const email = this.value.trim();
                
                // Limpiar timeout anterior
                if (timeoutId) {
                    clearTimeout(timeoutId);
                }
                
                // Resetear estilos
                emailInput.classList.remove('is-valid', 'is-invalid');
                emailFeedback.style.display = 'none';
                emailValidFeedback.style.display = 'none';
                emailValidado = false;
                
                // Validar formato
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    if (email.length > 0) {
                        emailInput.classList.add('is-invalid');
                        emailErrorMessage.textContent = 'Formato de correo inválido';
                        emailFeedback.style.display = 'block';
                    }
                    return;
                }
                
                // Esperar 500ms antes de validar en el servidor
                timeoutId = setTimeout(() => {
                    fetch('/auth/api/verificar-email/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({ email: email })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.existe) {
                            emailInput.classList.add('is-valid');
                            emailInput.classList.remove('is-invalid');
                            emailValidFeedback.style.display = 'block';
                            emailFeedback.style.display = 'none';
                            emailValidado = true;
                        } else {
                            emailInput.classList.add('is-invalid');
                            emailInput.classList.remove('is-valid');
                            emailErrorMessage.textContent = 'Este correo no está registrado en el sistema';
                            emailFeedback.style.display = 'block';
                            emailValidFeedback.style.display = 'none';
                            emailValidado = false;
                        }
                    })
                    .catch(error => {
                        console.error('Error al verificar email:', error);
                    });
                }, 500);
            });
            
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Validación básica
                const email = emailInput.value.trim();
                if (!email) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Por favor ingresa tu correo electrónico',
                        confirmButtonColor: '#dc2626'
                    });
                    return;
                }
                
                // Validar formato de email
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Por favor ingresa un correo electrónico válido',
                        confirmButtonColor: '#dc2626'
                    });
                    return;
                }
                
                // Verificar si el email fue validado
                if (!emailValidado) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Por favor ingresa un correo registrado en el sistema',
                        confirmButtonColor: '#dc2626'
                    });
                    return;
                }
                
                // Deshabilitar botón y mostrar loading
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';
                
                // Enviar el formulario
                this.submit();
            });
        });
    </script>
</body>
</html>
            }
            
            // Mostrar estado de carga
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Enviando código...';
            submitBtn.disabled = true;
            
            // Envío AJAX
            fetch(form.action, {
                method: 'POST',
                body: new FormData(form),
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: '¡Código enviado!',
                        text: data.message,
                        confirmButtonText: 'Continuar',
                        allowOutsideClick: false,
                        timer: 3000
                    }).then(() => {
                        window.location.href = data.redirect_url || '/auth/verificar-codigo-recuperacion/';
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: data.message || 'No se pudo procesar tu solicitud'
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error de conexión',
                    text: 'No se pudo conectar con el servidor. Inténtalo nuevamente.'
                });
            })
            .finally(() => {
                // Restaurar botón
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            });
        });
        
        // Efectos visuales para el input
        const emailInput = document.getElementById('email');
        
        emailInput.addEventListener('focus', function() {
            this.parentElement.classList.add('focused');
        });
        
        emailInput.addEventListener('blur', function() {
            this.parentElement.classList.remove('focused');
        });
        
        // Validación en tiempo real
        emailInput.addEventListener('input', function() {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (this.value && emailRegex.test(this.value)) {
                this.classList.remove('is-invalid');
                this.classList.add('is-valid');
            } else if (this.value) {
                this.classList.remove('is-valid');
                this.classList.add('is-invalid');
            } else {
                this.classList.remove('is-valid', 'is-invalid');
            }
        });
    });
    </script>
</body>
</html>