{% extends 'base.html' %}
{% load static %}

{% block title %}Crear Usuario - Dulcería Lilis{% endblock %}

{% block extra_css %}
<style>
.form-card {
    background: linear-gradient(135deg, #9c0202 0%, #ec0505 100%);
    border-radius: 20px;
    padding: 30px;
    color: white !important;
    margin-bottom: 30px;
}

.form-card h2,
.form-card h2 i,
.form-card p {
    color: white !important;
}

/* Estilos muy específicos para forzar el color blanco */
div.form-card h2 {
    color: white !important;
}

div.form-card h2 i.fas {
    color: white !important;
}

div.form-card p {
    color: white !important;
}

/* JavaScript para forzar color blanco */
</style>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Forzar color blanco en todos los elementos de headers de CRUDs
    const headers = document.querySelectorAll('.form-card h1, .form-card h2, .form-card h3, .form-card h4, .form-card h5, .form-card h6, .header-card h1, .header-card h2, .header-card h3, .header-card h4, .header-card h5, .header-card h6');
    const paragraphs = document.querySelectorAll('.form-card p, .header-card p');
    const icons = document.querySelectorAll('.form-card i, .header-card i');
    
    headers.forEach(function(element) {
        element.style.color = 'white';
        element.style.setProperty('color', 'white', 'important');
    });
    
    paragraphs.forEach(function(element) {
        element.style.color = 'white';
        element.style.setProperty('color', 'white', 'important');
    });
    
    icons.forEach(function(element) {
        element.style.color = 'white';
        element.style.setProperty('color', 'white', 'important');
    });
});
</script>
<style>

.form-container {
    background: white;
    border-radius: 15px;
    padding: 30px;
    box-shadow: 0 10px 30px rgba(255, 254, 254, 0.1);
}

.form-section {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
    border-left: 4px solid #af0202;
}

.form-section h5 {
    color: #b90202;
    margin-bottom: 15px;
    font-weight: 600;
}

.required::after {
    content: ' *';
    color: #dc3545;
}

.form-control:focus, .form-select:focus {
    border-color: #ac0000;
    box-shadow: 0 0 0 0.2rem rgba(255, 255, 255, 0.25);
}

.btn-primary {
    background: linear-gradient(135deg, #6f42c1 0%, #e83e8c 100%);
    border: none;
    padding: 12px 30px;
    border-radius: 8px;
    font-weight: 600;
    transition: all 0.3s ease;
}

.btn-primary:hover {
    background: linear-gradient(135deg, #5a2d91 0%, #d91a72 100%);
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(111, 66, 193, 0.3);
}

.btn-secondary {
    background: #ffffff;
    border: none;
    padding: 12px 30px;
    border-radius: 8px;
    font-weight: 600;
    transition: all 0.3s ease;
}

.btn-secondary:hover {
    background: #ffffff;
    transform: translateY(-2px);
}

.help-text {
    font-size: 0.875rem;
    color: #ffffff;
    margin-top: 4px;
}

.invalid-feedback {
    display: block;
}

.password-strength {
    margin-top: 5px;
}

.strength-bar {
    height: 4px;
    border-radius: 2px;
    transition: all 0.3s ease;
}

.strength-weak { background-color: #dc3545; }
.strength-medium { background-color: #ffc107; }
.strength-strong { background-color: #28a745; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="form-card">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2 style="color: white !important;"><i class="fas fa-user-plus me-2" style="color: white !important;"></i>Crear Nuevo Usuario</h2>
                <p class="mb-0" style="color: white !important;">Complete la información del nuevo usuario</p>
            </div>
            <a href="{% url 'autenticacion:usuario_listar' %}" class="btn btn-light">
                <i class="fas fa-arrow-left me-2"></i>Volver a Lista
            </a>
        </div>
    </div>

    <div class="form-container">
        <form id="usuario-form" method="POST" novalidate>
            {% csrf_token %}
            
            <!-- Información de Acceso -->
            <div class="form-section">
                <h5><i class="fas fa-key me-2"></i>Información de Acceso</h5>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="username" class="form-label required">Nombre de Usuario</label>
                        <input type="text" 
                               class="form-control{% if errores.username %} is-invalid{% endif %}" 
                               id="username" 
                               name="username" 
                               required
                               maxlength="8"
                               oninput="this.value = this.value.slice(0, 8).toLowerCase().replace(/[^a-z0-9_-]/g, '')"
                               value="{{ datos.username|default:'' }}"
                               placeholder="usuario1">
                        <div class="help-text">Entre 3 y 8 caracteres, solo letras, números y guiones</div>
                        <div class="invalid-feedback">{{ errores.username|default:'' }}</div>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" 
                               class="form-control{% if errores.email %} is-invalid{% endif %}" 
                               id="email" 
                               name="email"
                               value="{{ datos.email|default:'' }}"
                               placeholder="usuario@empresa.com"
                               maxlength="50"
                               oninput="this.value = this.value.slice(0, 50)">
                        <div class="help-text">Email para notificaciones (máximo 50 caracteres)</div>
                        <div class="invalid-feedback">{{ errores.email|default:'' }}</div>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="password" class="form-label required">Contraseña</label>
                        <input type="password" 
                               class="form-control{% if errores.password %} is-invalid{% endif %}" 
                               id="password" 
                               name="password" 
                               required
                               minlength="6"
                               placeholder="********">
                        <div class="password-strength">
                            <div class="strength-bar" id="strength-bar"></div>
                            <small id="strength-text" class="text-muted"></small>
                        </div>
                        <div class="invalid-feedback">{{ errores.password|default:'' }}</div>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="password_confirm" class="form-label required">Confirmar Contraseña</label>
                        <input type="password" 
                               class="form-control{% if errores.password_confirm %} is-invalid{% endif %}" 
                               id="password_confirm" 
                               name="password_confirm" 
                               required
                               placeholder="********">
                        <div class="help-text">Debe coincidir con la contraseña anterior</div>
                        <div class="invalid-feedback">{{ errores.password_confirm|default:'' }}</div>
                    </div>
                </div>
            </div>

            <!-- Información Personal -->
            <div class="form-section">
                <h5><i class="fas fa-user me-2"></i>Información Personal</h5>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="nombres" class="form-label required">Nombres</label>
                        <input type="text" 
                               class="form-control{% if errores.nombres %} is-invalid{% endif %}" 
                               id="nombres" 
                               name="nombres" 
                               required
                               maxlength="8"
                               oninput="this.value = this.value.slice(0, 8)"
                               value="{{ datos.nombres|default:'' }}"
                               placeholder="Juan">
                        <div class="help-text">Entre 2 y 8 caracteres. Solo letras</div>
                        <div class="invalid-feedback">{{ errores.nombres|default:'' }}</div>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="apellidos" class="form-label required">Apellidos</label>
                        <input type="text" 
                               class="form-control{% if errores.apellidos %} is-invalid{% endif %}" 
                               id="apellidos" 
                               name="apellidos" 
                               required
                               maxlength="8"
                               oninput="this.value = this.value.slice(0, 8)"
                               value="{{ datos.apellidos|default:'' }}"
                               placeholder="Pérez">
                        <div class="help-text">Entre 2 y 8 caracteres. Solo letras</div>
                        <div class="invalid-feedback">{{ errores.apellidos|default:'' }}</div>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="telefono" class="form-label">Teléfono</label>
                        <input type="tel" 
                               class="form-control{% if errores.telefono %} is-invalid{% endif %}" 
                               id="telefono" 
                               name="telefono"
                               maxlength="15"
                               pattern="[0-9+\-\s()]*"
                               oninput="this.value = this.value.replace(/[^0-9+\-\s()]/g, '').slice(0, 15)"
                               value="{{ datos.telefono|default:'' }}"
                               placeholder="+56 9 1234 5678">
                        <div class="help-text">Teléfono de contacto, máximo 15 caracteres (opcional)</div>
                        <div class="invalid-feedback">{{ errores.telefono|default:'' }}</div>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="area_unidad" class="form-label">Área/Unidad</label>
                        <input type="text" 
                               class="form-control{% if errores.area_unidad %} is-invalid{% endif %}" 
                               id="area_unidad" 
                               name="area_unidad"
                               maxlength="100"
                               oninput="this.value = this.value.slice(0, 100)"
                               value="{{ datos.area_unidad|default:'' }}"
                               placeholder="Ventas, Administración, etc.">
                        <div class="help-text">Área o departamento de trabajo, máximo 100 caracteres</div>
                        <div class="invalid-feedback">{{ errores.area_unidad|default:'' }}</div>
                    </div>
                </div>
            </div>

            <!-- Configuración del Sistema -->
            <div class="form-section">
                <h5><i class="fas fa-cogs me-2"></i>Configuración del Sistema</h5>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="rol_id" class="form-label required">Rol</label>
                        <select class="form-select{% if errores.rol_id %} is-invalid{% endif %}" 
                                id="rol_id" 
                                name="rol_id" 
                                required>
                            <option value="">Seleccione un rol...</option>
                            {% for rol in roles %}
                                <option value="{{ rol.id }}"{% if datos.rol_id == rol.id|stringformat:"s" %} selected{% endif %}>
                                    {{ rol.nombre }}{% if rol.descripcion %} - {{ rol.descripcion }}{% endif %}
                                </option>
                            {% endfor %}
                        </select>
                        <div class="help-text">Define los permisos del usuario</div>
                        <div class="invalid-feedback">{{ errores.rol_id|default:'' }}</div>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="estado" class="form-label">Estado</label>
                        <select class="form-select{% if errores.estado %} is-invalid{% endif %}" 
                                id="estado" 
                                name="estado">
                            {% for valor, etiqueta in estados %}
                                <option value="{{ valor }}"{% if datos.estado == valor or valor == 'ACTIVO' and not datos.estado %} selected{% endif %}>
                                    {{ etiqueta }}
                                </option>
                            {% endfor %}
                        </select>
                        <div class="help-text">Estado inicial del usuario</div>
                        <div class="invalid-feedback">{{ errores.estado|default:'' }}</div>
                    </div>
                </div>
            </div>

            <!-- Observaciones -->
            <div class="form-section">
                <h5><i class="fas fa-comments me-2"></i>Observaciones</h5>
                <div class="row g-3">
                    <div class="col-12">
                        <label for="observaciones" class="form-label">Observaciones</label>
                        <textarea class="form-control{% if errores.observaciones %} is-invalid{% endif %}" 
                                  id="observaciones" 
                                  name="observaciones" 
                                  rows="3"
                                  placeholder="Notas adicionales sobre el usuario...">{{ datos.observaciones|default:'' }}</textarea>
                        <div class="help-text">Información adicional relevante</div>
                        <div class="invalid-feedback">{{ errores.observaciones|default:'' }}</div>
                    </div>
                </div>
            </div>

            <!-- Botones -->
            <div class="d-flex justify-content-end gap-3 mt-4">
                <a href="{% url 'autenticacion:usuario_listar' %}" class="btn btn-secondary">
                    <i class="fas fa-times me-2"></i>Cancelar
                </a>
                <button type="submit" class="btn btn-primary" id="btn-guardar">
                    <i class="fas fa-save me-2"></i>Crear Usuario
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const passwordInput = document.getElementById('password');
    const passwordConfirm = document.getElementById('password_confirm');
    const strengthBar = document.getElementById('strength-bar');
    const strengthText = document.getElementById('strength-text');
    const form = document.getElementById('usuario-form');

    // Validación de fortaleza de contraseña
    passwordInput.addEventListener('input', function() {
        const password = this.value;
        const strength = checkPasswordStrength(password);
        
        strengthBar.className = 'strength-bar';
        strengthBar.style.width = '0%';
        
        if (password.length > 0) {
            if (strength.score <= 2) {
                strengthBar.classList.add('strength-weak');
                strengthBar.style.width = '33%';
                strengthText.textContent = 'Débil';
            } else if (strength.score <= 3) {
                strengthBar.classList.add('strength-medium');
                strengthBar.style.width = '66%';
                strengthText.textContent = 'Media';
            } else {
                strengthBar.classList.add('strength-strong');
                strengthBar.style.width = '100%';
                strengthText.textContent = 'Fuerte';
            }
        } else {
            strengthText.textContent = '';
        }
    });

    // Validación de coincidencia de contraseñas
    passwordConfirm.addEventListener('input', function() {
        const password = passwordInput.value;
        const confirm = this.value;
        
        if (confirm.length > 0) {
            if (password === confirm) {
                this.classList.remove('is-invalid');
                this.classList.add('is-valid');
            } else {
                this.classList.remove('is-valid');
                this.classList.add('is-invalid');
                this.nextElementSibling.textContent = 'Las contraseñas no coinciden';
            }
        } else {
            this.classList.remove('is-valid', 'is-invalid');
        }
    });

    // Validación del formulario
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        let isValid = true;
        const requiredFields = ['username', 'nombres', 'apellidos', 'password', 'password_confirm', 'rol_id'];
        
        // Limpiar validaciones anteriores
        document.querySelectorAll('.is-invalid').forEach(el => {
            if (!el.classList.contains('form-control') || !el.getAttribute('data-server-error')) {
                el.classList.remove('is-invalid');
            }
        });
        
        // Validar campos requeridos
        requiredFields.forEach(fieldName => {
            const field = document.getElementById(fieldName);
            if (!field.value.trim()) {
                field.classList.add('is-invalid');
                isValid = false;
            }
        });
        
        // Validar coincidencia de contraseñas
        if (passwordInput.value !== passwordConfirm.value) {
            passwordConfirm.classList.add('is-invalid');
            isValid = false;
        }
        
        // Validar fortaleza de contraseña
        if (passwordInput.value.length < 6) {
            passwordInput.classList.add('is-invalid');
            isValid = false;
        }
        
        if (!isValid) {
            Swal.fire({
                icon: 'warning',
                title: 'Datos incompletos',
                text: 'Por favor, complete todos los campos requeridos correctamente.',
                confirmButtonColor: '#6f42c1'
            });
            return;
        }
        
        // Enviar formulario
        this.submit();
    });

    function checkPasswordStrength(password) {
        let score = 0;
        
        if (password.length >= 8) score++;
        if (password.length >= 12) score++;
        if (/[a-z]/.test(password)) score++;
        if (/[A-Z]/.test(password)) score++;
        if (/[0-9]/.test(password)) score++;
        if (/[^A-Za-z0-9]/.test(password)) score++;
        
        return { score };
    }
});

// Mostrar notificaciones
{% if messages %}
    {% for message in messages %}
        {% if message.tags == 'success' %}
            Swal.fire({
                icon: 'success',
                title: '¡Éxito!',
                text: '{{ message }}',
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true
            });
        {% elif message.tags == 'error' %}
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: '{{ message }}',
                confirmButtonColor: '#6f42c1'
            });
        {% endif %}
    {% endfor %}
{% endif %}
</script>
{% endblock %}