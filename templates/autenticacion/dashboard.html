{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard - Lilis System{% endblock %}

{% block extra_css %}
<style>
    /* Fondo de la página completa */
    .dashboard-container {
        background-image: url("{% static 'img/backgrounds/background-conitos.jpg' %}");
        background-size: cover;
        background-position: center;
        background-attachment: fixed;
        background-repeat: no-repeat;
        min-height: 100vh;
        padding: 20px 0;
    }
    
    /* Overlay sutil para mejorar legibilidad */
    .dashboard-container::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 248, 240, 0.7);
        z-index: 0;
    }
    
    /* Asegurar que el contenido esté sobre el overlay */
    .dashboard-container > * {
        position: relative;
        z-index: 1;
    }
    
    /* Tarjetas con fondo semi-transparente */
    .card {
        background: rgba(255, 255, 255, 0.95) !important;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(220, 38, 38, 0.2);
    }
    
    /* Carrusel con sombra más pronunciada */
    .carousel-inner {
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4) !important;
    }
    
    /* Botón de gestión de productos */
    .alert-info {
        background: rgba(220, 38, 38, 0.95) !important;
        backdrop-filter: blur(10px);
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container" style="position: relative;">
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h2 class="mb-4">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </h2>
            </div>
        </div>
    
    <!-- Carrusel de Imágenes - Productos Lilis -->
    <div class="row mb-4">
        <div class="col-12">
            <div id="carouselExample" class="carousel slide" data-bs-ride="carousel">
                <div class="carousel-indicators">
                    <button type="button" data-bs-target="#carouselExample" data-bs-slide-to="0" class="active" aria-current="true" aria-label="Slide 1"></button>
                    <button type="button" data-bs-target="#carouselExample" data-bs-slide-to="1" aria-label="Slide 2"></button>
                    <button type="button" data-bs-target="#carouselExample" data-bs-slide-to="2" aria-label="Slide 3"></button>
                </div>
                <div class="carousel-inner" style="border-radius: 15px; overflow: hidden; box-shadow: 0 8px 20px rgba(220, 38, 38, 0.3);">
                    <div class="carousel-item active">
                        <img src="{% static 'img/carousel/lilis-productos-1.jpg' %}" class="d-block w-100" alt="Productos Lilis - Galletas y Conitos" style="height: 450px; object-fit: cover;">
                        <div class="carousel-caption d-none d-md-block" style="background: linear-gradient(to top, rgba(220, 38, 38, 0.9), rgba(220, 38, 38, 0.7)); border-radius: 10px; padding: 20px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);">
                            <h3 class="fw-bold"><i class="fas fa-cookie-bite"></i> Nuestros Productos Artesanales</h3>
                            <p class="mb-0">Galletas Trio, Conitos de Higo y Galletones de Papaya - Hechos a Mano</p>
                        </div>
                    </div>
                    <div class="carousel-item">
                        <img src="{% static 'img/carousel/lilis-productos-2.jpg' %}" class="d-block w-100" alt="Alfajores Lilis" style="height: 450px; object-fit: cover;">
                        <div class="carousel-caption d-none d-md-block" style="background: linear-gradient(to top, rgba(220, 38, 38, 0.9), rgba(220, 38, 38, 0.7)); border-radius: 10px; padding: 20px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);">
                            <h3 class="fw-bold"><i class="fas fa-heart"></i> Alfajores Premium</h3>
                            <p class="mb-0">Dulzura tradicional chilena con ingredientes de calidad</p>
                        </div>
                    </div>
                    <div class="carousel-item">
                        <img src="{% static 'img/carousel/lilis-productos-3.jpg' %}" class="d-block w-100" alt="Variedad Lilis" style="height: 450px; object-fit: cover;">
                        <div class="carousel-caption d-none d-md-block" style="background: linear-gradient(to top, rgba(220, 38, 38, 0.9), rgba(220, 38, 38, 0.7)); border-radius: 10px; padding: 20px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);">
                            <h3 class="fw-bold"><i class="fas fa-star"></i> Variedad de Sabores</h3>
                            <p class="mb-0">Desde galletas rellenas hasta deliciosos conitos bañados en chocolate</p>
                        </div>
                    </div>
                </div>
                <button class="carousel-control-prev" type="button" data-bs-target="#carouselExample" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Anterior</span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#carouselExample" data-bs-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Siguiente</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Botón Principal CRUD Productos -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-info" style="background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%); border: none; box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);">
                <div class="d-flex align-items-center justify-content-between">
                    <div class="text-white">
                        <h4 class="mb-1">
                            <i class="fas fa-boxes"></i> Gestión de Productos
                        </h4>
                        <p class="mb-0">Accede al sistema completo de gestión de productos con todos tus datos de la base de datos</p>
                    </div>
                    <div>
                        <a href="{% url 'producto_listar' %}" class="btn btn-light btn-lg px-4 py-2 me-2" style="font-weight: bold;">
                            <i class="fas fa-list"></i> Ver Productos
                        </a>
                        {% if usuario.rol.nombre == 'ADMIN' or usuario.rol.nombre == 'GERENTE' %}
                        <a href="{% url 'producto_crear' %}" class="btn btn-outline-light btn-lg px-4 py-2" style="border: 2px solid white; font-weight: bold;">
                            <i class="fas fa-plus"></i> Nuevo
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Tarjetas de estadísticas -->
    <div class="row">
        <div class="col-md-3 mb-4">
            <div class="card text-white" style="background: linear-gradient(135deg, #991b1b 0%, #dc2626 100%); box-shadow: 0 4px 8px rgba(153, 27, 27, 0.3);">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title">Carrito</h6>
                            <h2>{{ carrito_count }}</h2>
                        </div>
                        <div>
                            <i class="fas fa-shopping-cart fa-3x opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 mb-4">
            <div class="card text-white" style="background: linear-gradient(135deg, #b91c1c 0%, #991b1b 100%); box-shadow: 0 4px 8px rgba(185, 28, 28, 0.3);">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title">Notificaciones</h6>
                            <h2>{{ notificaciones_count }}</h2>
                        </div>
                        <div>
                            <i class="fas fa-bell fa-3x opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 mb-4">
            <div class="card text-white" style="background: linear-gradient(135deg, #7f1d1d 0%, #b91c1c 100%); box-shadow: 0 4px 8px rgba(127, 29, 29, 0.3);">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title">Rol</h6>
                            <h6>{{ usuario.rol.nombre }}</h6>
                        </div>
                        <div>
                            <i class="fas fa-user-tag fa-3x opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Sección de Cards de Módulos Principales -->
    <div class="row mb-4 justify-content-center">
        <div class="col-12 mb-3">
            <h4 class="text-center"><i class="fas fa-th-large"></i> Módulos del Sistema</h4>
        </div>
        
        <!-- Tarjeta 1: Ver Productos -->
        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card h-100 shadow-sm" style="border-top: 4px solid #dc2626; border-radius: 10px;">
                <img src="https://images.unsplash.com/photo-1516594915697-87eb3b1c14ea?w=400&h=200&fit=crop" 
                     class="card-img-top" alt="Productos" style="height: 200px; object-fit: cover; border-radius: 10px 10px 0 0;">
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title text-center">
                        <i class="fas fa-boxes text-danger"></i> Productos
                    </h5>
                    <p class="card-text text-center flex-grow-1">
                        Gestiona el catálogo completo de productos, inventario, precios y categorías.
                    </p>
                    <div class="d-grid gap-2 mt-auto">
                        <a href="{% url 'producto_listar' %}" class="btn btn-danger btn-lg">
                            <i class="fas fa-eye"></i> Ver Productos
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tarjeta 2: Ir a Ventas -->
        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card h-100 shadow-sm" style="border-top: 4px solid #dc2626; border-radius: 10px;">
                <img src="https://images.unsplash.com/photo-1556742111-a301076d9d18?w=400&h=200&fit=crop" 
                     class="card-img-top" alt="Ventas" style="height: 200px; object-fit: cover; border-radius: 10px 10px 0 0;">
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title text-center">
                        <i class="fas fa-shopping-cart text-danger"></i> Ventas
                    </h5>
                    <p class="card-text text-center flex-grow-1">
                        Registra y controla todas las ventas, facturas y transacciones del negocio.
                    </p>
                    <div class="d-grid gap-2 mt-auto">
                        <a href="#" class="btn btn-danger btn-lg">
                            <i class="fas fa-cash-register"></i> Ir a Ventas
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tarjeta 3: Configurar -->
        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card h-100 shadow-sm" style="border-top: 4px solid #dc2626; border-radius: 10px;">
                <img src="https://images.unsplash.com/photo-1454165804606-c3d57bc86b40?w=400&h=200&fit=crop" 
                     class="card-img-top" alt="Configuración" style="height: 200px; object-fit: cover; border-radius: 10px 10px 0 0;">
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title text-center">
                        <i class="fas fa-cog text-danger"></i> Configuración
                    </h5>
                    <p class="card-text text-center flex-grow-1">
                        Ajustes del sistema, usuarios, permisos y parámetros generales.
                    </p>
                    <div class="d-grid gap-2 mt-auto">
                        <a href="{% url 'perfil_usuario' %}" class="btn btn-danger btn-lg">
                            <i class="fas fa-sliders-h"></i> Configurar
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Información del usuario -->
    <div class="row">
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header text-white" style="background-color: #dc2626;">
                    <h5 class="mb-0"><i class="fas fa-user-circle"></i> Mi Cuenta</h5>
                </div>
                <div class="card-body text-center">
                    <div class="mb-3">
                        <h5 class="mb-1">{{ usuario.get_full_name }}</h5>
                        <p class="text-muted mb-0">{{ usuario.rol.nombre }}</p>
                    </div>
                    <div class="d-grid">
                        <a href="{% url 'perfil_usuario' %}" class="btn text-white" style="background-color: #dc2626;">
                            <i class="fas fa-eye"></i> Ver Mi Perfil Completo
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header text-white" style="background-color: #dc2626;">
                    <h5 class="mb-0"><i class="fas fa-rocket"></i> Acciones Rápidas</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        {% if usuario.rol.nombre == 'ADMIN' or usuario.rol.nombre == 'SUPERVISOR' %}
                            <a href="{% url 'catalogo_listar' %}" class="btn btn-info">
                                <i class="fas fa-list"></i> Ver Catálogo
                            </a>
                            
                            {% if usuario.rol.permisos.catalogo.crear %}
                                <a href="{% url 'catalogo_crear' %}" class="btn btn-success">
                                    <i class="fas fa-plus"></i> Crear Producto Catálogo
                                </a>
                            {% endif %}
                        {% endif %}
                        
                        <!-- Accesos rápidos para Maestros -->
                        {% if usuario.rol.nombre == 'ADMIN' or usuario.rol.nombre == 'GERENTE' or usuario.rol.nombre == 'BODEGUERO' %}
                            <hr>
                            <h6 class="fw-bold">
                                <i class="fas fa-crown"></i> Gestión de Maestros
                            </h6>
                            <a href="{% url 'producto_listar' %}" class="btn btn-primary mb-2">
                                <i class="fas fa-boxes"></i> Gestión de Productos
                            </a>
                            
                            {% if usuario.rol.nombre == 'ADMIN' or usuario.rol.nombre == 'GERENTE' %}
                            <a href="{% url 'producto_crear' %}" class="btn btn-primary mb-2">
                                <i class="fas fa-plus"></i> Nuevo Producto
                            </a>
                            {% endif %}
                            
                            <a href="{% url 'proveedor_listar' %}" class="btn btn-warning">
                                <i class="fas fa-truck"></i> Proveedores
                            </a>
                        {% endif %}
                        
                        <hr>
                        <h6 class="text-muted">Sistema</h6>
                        <button onclick="mostrarCarrito()" class="btn btn-info">
                            <i class="fas fa-shopping-cart"></i> Ver Carrito
                        </button>
                        
                        <button onclick="mostrarNotificaciones()" class="btn btn-warning">
                            <i class="fas fa-bell"></i> Ver Notificaciones
                        </button>
                        
                        <button onclick="testNotification()" class="btn btn-secondary">
                            <i class="fas fa-vial"></i> Probar Notificación
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Resumen de actividad -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header text-white" style="background-color: #dc2626;">
                    <h5 class="mb-0"><i class="fas fa-chart-bar"></i> Resumen de Actividad</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-6">
                            <div class="p-3">
                                <i class="fas fa-shopping-cart fa-2x mb-2 text-warning"></i>
                                <h4 class="mb-1 text-warning">{{ carrito_count }}</h4>
                                <p class="text-muted mb-0">Items en carrito</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="p-3">
                                <i class="fas fa-bell fa-2x mb-2 text-info"></i>
                                <h4 class="mb-1 text-info">{{ notificaciones_count }}</h4>
                                <p class="text-muted mb-0">Notificaciones no leídas</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div> <!-- Cierre container -->
</div> <!-- Cierre dashboard-container -->

{% endblock %}

{% block extra_js %}
<script>
    // Función para probar notificación
    function testNotification() {
        fetch('/api/notificaciones/agregar/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                titulo: 'Notificación de Prueba',
                mensaje: 'Esta es una notificación de prueba del sistema',
                tipo: 'info'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                Swal.fire({
                    icon: 'success',
                    title: '¡Éxito!',
                    text: 'Notificación agregada correctamente',
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 3000
                });
                actualizarContadores();
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }
    
    // Función para obtener cookie CSRF
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}
