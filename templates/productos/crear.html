{% extends 'base.html' %}
{% load static %}

{% block title %}Crear Producto | Dulcería Lilis{% endblock %}

{% block extra_css %}
<style>
    .card-header {
        background: linear-gradient(135deg, #e91e63, #f06292);
        color: white;
        border-radius: 12px 12px 0 0 !important;
    }
    
    .form-control:focus {
        border-color: #e91e63;
        box-shadow: 0 0 0 0.2rem rgba(233, 30, 99, 0.25);
    }
    
    .btn-candy {
        background: linear-gradient(135deg, #e91e63, #f06292);
        border: none;
        color: white;
        border-radius: 25px;
        padding: 10px 30px;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    
    .btn-candy:hover {
        background: linear-gradient(135deg, #d81b60, #e91e63);
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(233, 30, 99, 0.3);
        color: white;
    }
    
    .btn-outline-secondary {
        border-color: #6c757d;
        color: #6c757d;
        border-radius: 25px;
        padding: 10px 30px;
        font-weight: 500;
    }
    
    .btn-outline-secondary:hover {
        background-color: #6c757d;
        border-color: #6c757d;
        transform: translateY(-2px);
    }
    
    .required {
        color: #e91e63;
    }
    
    .form-group {
        margin-bottom: 1.5rem;
    }
    
    .form-control, .form-select {
        border-radius: 8px;
        border: 2px solid #e3f2fd;
        padding: 12px 15px;
        transition: all 0.3s ease;
    }
    
    .form-control:hover, .form-select:hover {
        border-color: #bbdefb;
    }
    
    .card {
        border: none;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        border-radius: 15px;
        overflow: hidden;
    }
    
    .alert {
        border-radius: 10px;
        border: none;
    }
    
    .alert-success {
        background: linear-gradient(135deg, #4caf50, #66bb6a);
        color: white;
    }
    
    .alert-error {
        background: linear-gradient(135deg, #f44336, #ef5350);
        color: white;
    }
    
    .form-check-input:checked {
        background-color: #e91e63;
        border-color: #e91e63;
    }
    
    .form-check-input:focus {
        box-shadow: 0 0 0 0.25rem rgba(233, 30, 99, 0.25);
    }
    
    .preview-image {
        max-width: 200px;
        max-height: 200px;
        border-radius: 10px;
        border: 3px solid #e3f2fd;
        margin-top: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Encabezado -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-0">
                        <i class="fas fa-plus-circle text-candy me-2"></i>
                        Crear Nuevo Producto
                    </h2>
                    <p class="text-muted mb-0">Agrega un nuevo producto al catálogo de la dulcería</p>
                </div>
                <a href="{% url 'productos:lista' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Volver
                </a>
            </div>
        </div>
    </div>

    <!-- Formulario -->
    <div class="row justify-content-center">
        <div class="col-lg-8 col-xl-7">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-candy-cane me-2"></i>
                        Información del Producto
                    </h5>
                </div>
                <div class="card-body p-4">
                    <!-- Alertas -->
                    <div id="alert-container"></div>
                    
                    <form id="producto-form" method="post" novalidate>
                        {% csrf_token %}
                        
                        <!-- Información Básica -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="sku" class="form-label">
                                        SKU <span class="required">*</span>
                                    </label>
                                    <input type="text" 
                                           class="form-control" 
                                           id="sku" 
                                           name="sku" 
                                           placeholder="Ej: CHOC001"
                                           required>
                                    <div class="form-text">Código único del producto</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="nombre" class="form-label">
                                        Nombre <span class="required">*</span>
                                    </label>
                                    <input type="text" 
                                           class="form-control" 
                                           id="nombre" 
                                           name="nombre" 
                                           placeholder="Nombre del producto"
                                           required>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="descripcion" class="form-label">Descripción</label>
                            <textarea class="form-control" 
                                      id="descripcion" 
                                      name="descripcion" 
                                      rows="3"
                                      placeholder="Descripción detallada del producto"></textarea>
                        </div>

                        <!-- Categorización -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="categoria" class="form-label">
                                        Categoría <span class="required">*</span>
                                    </label>
                                    <select class="form-select" id="categoria" name="categoria" required>
                                        <option value="">Seleccionar categoría</option>
                                        {% for categoria in categorias %}
                                            <option value="{{ categoria.id }}">{{ categoria.nombre }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="marca" class="form-label">Marca</label>
                                    <select class="form-select" id="marca" name="marca">
                                        <option value="">Sin marca específica</option>
                                        {% for marca in marcas %}
                                            <option value="{{ marca.id }}">{{ marca.nombre }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="modelo" class="form-label">Modelo/Presentación</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="modelo" 
                                   name="modelo" 
                                   placeholder="Ej: Bolsa 250g, Caja 12 unidades">
                        </div>

                        <!-- Precios -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="precio_venta" class="form-label">
                                        Precio de Venta <span class="required">*</span>
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="number" 
                                               class="form-control" 
                                               id="precio_venta" 
                                               name="precio_venta" 
                                               step="0.01" 
                                               min="0.01"
                                               placeholder="0.00"
                                               required>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="costo_estandar" class="form-label">Costo Estándar</label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="number" 
                                               class="form-control" 
                                               id="costo_estandar" 
                                               name="costo_estandar" 
                                               step="0.01" 
                                               min="0.01"
                                               placeholder="0.00">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Configuración -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="impuesto_iva" class="form-label">IVA (%)</label>
                                    <input type="number" 
                                           class="form-control" 
                                           id="impuesto_iva" 
                                           name="impuesto_iva" 
                                           value="19" 
                                           min="0" 
                                           max="100"
                                           step="0.01">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="estado" class="form-label">Estado</label>
                                    <select class="form-select" id="estado" name="estado">
                                        {% for codigo, nombre in estados %}
                                            <option value="{{ codigo }}" {% if codigo == 'ACTIVO' %}selected{% endif %}>
                                                {{ nombre }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Stock Inicial -->
                        <div class="card mb-3" style="background: #f8f9fa; border: 2px dashed #e91e63;">
                            <div class="card-body">
                                <h6 class="mb-3">
                                    <i class="fas fa-warehouse text-primary me-2"></i>
                                    Stock Inicial (Opcional)
                                </h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="bodega_inicial" class="form-label">
                                                <i class="fas fa-building me-1"></i>
                                                Bodega
                                            </label>
                                            <select class="form-select" id="bodega_inicial" name="bodega_inicial">
                                                <option value="">-- No asignar stock inicial --</option>
                                                {% for bodega in bodegas %}
                                                    <option value="{{ bodega.id }}">
                                                        {{ bodega.nombre }} ({{ bodega.codigo }})
                                                    </option>
                                                {% endfor %}
                                            </select>
                                            <small class="text-muted">
                                                Puedes agregar stock después desde el módulo de inventario
                                            </small>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="cantidad_inicial" class="form-label">
                                                <i class="fas fa-boxes me-1"></i>
                                                Cantidad Inicial
                                            </label>
                                            <input type="number" 
                                                   class="form-control" 
                                                   id="cantidad_inicial" 
                                                   name="cantidad_inicial" 
                                                   min="0" 
                                                   step="0.01"
                                                   value="0"
                                                   placeholder="0.00">
                                            <small class="text-muted">
                                                Solo se asignará si seleccionas una bodega
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Controles especiales -->
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-check mb-3">
                                    <input class="form-check-input" 
                                           type="checkbox" 
                                           id="perishable" 
                                           name="perishable">
                                    <label class="form-check-label" for="perishable">
                                        <i class="fas fa-clock text-warning me-1"></i>
                                        Producto perecedero
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check mb-3">
                                    <input class="form-check-input" 
                                           type="checkbox" 
                                           id="control_por_lote" 
                                           name="control_por_lote">
                                    <label class="form-check-label" for="control_por_lote">
                                        <i class="fas fa-boxes text-info me-1"></i>
                                        Control por lote
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check mb-3">
                                    <input class="form-check-input" 
                                           type="checkbox" 
                                           id="control_por_serie" 
                                           name="control_por_serie">
                                    <label class="form-check-label" for="control_por_serie">
                                        <i class="fas fa-barcode text-success me-1"></i>
                                        Control por serie
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Imagen -->
                        <div class="form-group">
                            <label for="imagen_url" class="form-label">URL de Imagen</label>
                            <input type="url" 
                                   class="form-control" 
                                   id="imagen_url" 
                                   name="imagen_url" 
                                   placeholder="https://ejemplo.com/imagen.jpg">
                            <div class="form-text">Opcional: URL de la imagen del producto</div>
                            <img id="preview-imagen" class="preview-image d-none" alt="Vista previa">
                        </div>

                        <!-- Botones -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="d-flex justify-content-end gap-3">
                                    <a href="{% url 'productos:lista' %}" class="btn btn-outline-secondary">
                                        <i class="fas fa-times me-2"></i>Cancelar
                                    </a>
                                    <button type="submit" class="btn btn-candy" id="btn-guardar">
                                        <i class="fas fa-save me-2"></i>
                                        <span id="texto-guardar">Crear Producto</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('producto-form');
    const btnGuardar = document.getElementById('btn-guardar');
    const textoGuardar = document.getElementById('texto-guardar');
    const alertContainer = document.getElementById('alert-container');
    const imagenUrl = document.getElementById('imagen_url');
    const previewImagen = document.getElementById('preview-imagen');

    // Vista previa de imagen
    imagenUrl.addEventListener('input', function() {
        const url = this.value.trim();
        if (url) {
            previewImagen.src = url;
            previewImagen.classList.remove('d-none');
            previewImagen.onerror = function() {
                this.classList.add('d-none');
            };
        } else {
            previewImagen.classList.add('d-none');
        }
    });

    // Función para mostrar alertas
    function showAlert(message, type = 'success') {
        const alertClass = type === 'success' ? 'alert-success' : 'alert-error';
        const iconClass = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
        
        const alertHtml = `
            <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                <i class="fas ${iconClass} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        
        alertContainer.innerHTML = alertHtml;
        
        // Scroll hasta la alerta
        alertContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        
        // Auto-ocultar después de 5 segundos si es éxito
        if (type === 'success') {
            setTimeout(() => {
                const alert = alertContainer.querySelector('.alert');
                if (alert) {
                    alert.remove();
                }
            }, 5000);
        }
    }

    // Manejo del envío del formulario
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Cambiar estado del botón
        btnGuardar.disabled = true;
        textoGuardar.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Creando...';
        
        // Limpiar alertas anteriores
        alertContainer.innerHTML = '';
        
        const formData = new FormData(form);
        
        // Debug: verificar datos del formulario
        console.log('Datos del formulario:');
        for (let [key, value] of formData.entries()) {
            console.log(`${key}: ${value}`);
        }
        
        fetch(form.action || '{% url "productos:crear" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            console.log('Respuesta del servidor:', data);
            if (data.success) {
                showAlert(data.message, 'success');
                
                // Esperar un momento y redirigir
                setTimeout(() => {
                    window.location.href = '{% url "productos:lista" %}';
                }, 2000);
            } else {
                showAlert(data.message, 'error');
                
                // Restaurar botón
                btnGuardar.disabled = false;
                textoGuardar.innerHTML = '<i class="fas fa-save me-2"></i>Crear Producto';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Error inesperado al crear el producto', 'error');
            
            // Restaurar botón
            btnGuardar.disabled = false;
            textoGuardar.innerHTML = '<i class="fas fa-save me-2"></i>Crear Producto';
        });
    });

    // Validación en tiempo real
    const requiredFields = form.querySelectorAll('[required]');
    requiredFields.forEach(field => {
        field.addEventListener('blur', function() {
            if (this.value.trim() === '') {
                this.classList.add('is-invalid');
            } else {
                this.classList.remove('is-invalid');
                this.classList.add('is-valid');
            }
        });
        
        field.addEventListener('input', function() {
            if (this.classList.contains('is-invalid') && this.value.trim() !== '') {
                this.classList.remove('is-invalid');
                this.classList.add('is-valid');
            }
        });
    });

    // Formateo automático de precios
    const priceFields = document.querySelectorAll('input[type="number"][step="0.01"]');
    priceFields.forEach(field => {
        field.addEventListener('change', function() {
            if (this.value) {
                this.value = parseFloat(this.value).toFixed(2);
            }
        });
    });
});
</script>
{% endblock %}